---
title: "Martel Paper - Daily OA Pain"
date: "2024-03-18"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
urlcolor: blue
header-includes:    
  - \usepackage{lastpage}
  - \usepackage{fancyhdr}
  - \usepackage{setspace}
  - \usepackage{float}
  - \pagestyle{fancy}
  - \fancyhead[CO, CE]{Jiaqi Bi}
  - \fancyhead[LE, RO]{Martel - Daily OA Pain}
  - \fancyfoot[CO, CE]{\thepage \ of \pageref{LastPage}}
  - \floatplacement{figure}{H}
mainfont: Times New Roman
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Wrangling

```{r, warning = FALSE, message = FALSE}
## Load packages
library(tidyverse)
library(ggplot2)
library(tidyr)
library(haven)## This library provides functions to read sav file into R
library(lme4)
library(lmerTest)
```


```{r, message = FALSE}
## Read data
data_paper <- read_sav("Dataset; 2024.1.sav")
checkdf3 <- data_paper |> 
  subset(ID == 2072) |> 
  select(c(ID, 
           Level1_Even_DateIn, 
           Level1_Even_TimeIn,
           Wave_Day))

## Delete Weird ID 2072 those weird reporting days
data_paper <- data_paper |>
  filter(!(ID == 2072 & Wave_Day >= 7))
```

### Adjusting Wave Day 

\begin{itemize}
  \item $DT_i$ combines $D_i$ and $T_i$: `DateTime` variable
  \item $DT_0$ is the first response `DateTime` for each patient
  \item $W_i$ is the adjusted `Wave\_Day` variable
  \item Add a grace period $G$ for calculating the adjusted $W_i$, in our case $G=6$ hours
  \item Calculate the datetime difference $H_i$ in **hours** from the first response, incorporating the grace period:
  $$
  H_i = DT_i-DT_{i-1}
  $$
  \item Then apply the grace period indicator $I_i$:
  $$
  I_i=
  \begin{cases}
  1 & \text{if } H_{i} \leq 24 + G \\
  \left\lceil\frac{H_{i} - G}{24}\right\rceil & \text{otherwise}
  \end{cases}
  $$
  \item The initial response for `Wave\_Day` is 1, i.e., $W_0=1$, then the adjusted `Wave\_Day` $W_i$ is 
  $$
  W_i=\sum_{i=0}^{i-1} I_i
  $$
\end{itemize}


```{r, message = FALSE}
## Consecutive Days - Grace Period 6 hours
data_paper <- data_paper |>
  mutate(Lev1_DateTimeIn = as.POSIXct(strptime(paste(Level1_Even_DateIn, 
                                                     Level1_Even_TimeIn), 
                                          format="%Y-%m-%d %H:%M:"))) |>
  arrange(ID, Lev1_DateTimeIn) |>
  group_by(ID) |>
  mutate(
    TimeDiffHours = as.numeric(difftime(Lev1_DateTimeIn, 
                                        lag(Lev1_DateTimeIn, 
                                            default = first(Lev1_DateTimeIn)), 
                                        units = "hours")), # T diff
    WithinGracePeriod = if_else(TimeDiffHours <= 30, 
                                1, 
                                ceiling((TimeDiffHours - 6) / 24)), # Check grace period
    Wave_Day_Adjusted = cumsum(WithinGracePeriod) # Adjusted Wave_Day
  ) |>
  ungroup()

###### Check if the above approach is correct ######
checkdf <- data_paper |> select(c(ID, 
                                  Lev1_DateTimeIn, 
                                  TimeDiffHours, 
                                  WithinGracePeriod, 
                                  Wave_Day_Adjusted,
                                  Baseline_Demog_BMI))
checkdf2 <- checkdf |> subset(ID == 2072) # Weird ID 2072
max(checkdf$Wave_Day_Adjusted, na.rm = TRUE) 

```




```{r, message = FALSE}
## Fill in the gap of Wave_Day
data_paper2 <- data_paper |>
  group_by(ID) |>
  complete(Wave_Day = 1:14) |>
  ungroup()
```

```{r, message = FALSE, echo = TRUE, results = 'hide'}
## Check the aberrant values
summary(data_paper2$IndexLev1_NegativeAffect_Total) # Lev 1 Negative Affect 
summary(data_paper2$IndexLev1_Catastrophizing_Total) # Lev 1 Catas
summary(data_paper2$IndexLev2_QST_BaselinePPTh) # Lev 2 PPThs?
summary(data_paper2$IndexLev2_QST_TSPAve) # Lev 2 TSP?
summary(data_paper2$IndexLev2_QST_CpmTrialAve) # Lev 2 CPM?
summary(data_paper2$IndexLev1_PainAverage) # Lev 1 Pain?

###### Check if lagged value is correct ######
data_paper2_check <- data_paper2 |>
  select(c(ID, Wave_Day_Adjusted, IndexLev1_PainAverage, IndexLev1_PainAverage_Lagged))
```

$$
APE(t_i)=I(PAIN(t_i)-PAIN(t_i-1) \geq 20)
$$

```{r, results = 'hide', echo = TRUE}
## APE index
data_paper2 <- data_paper2 |>
  group_by(ID) |>
  mutate(APE = ifelse(IndexLev1_PainAverage - IndexLev1_PainAverage_Lagged >= 20, 1, 0))

###### Check if it is correctly coded ######
data_paper2_check <- data_paper2 |>
  select(c(ID, Wave_Day_Adjusted, 
           IndexLev1_PainAverage, 
           IndexLev1_PainAverage_Lagged, 
           APE))
```

For calculating the RPE based on the within person mean, define the indicator that the pain is above the average pain for person $i$ on day $t_i$. Note that $n_{t_i}=\max{t_i}$ for patient $i$.

$$
A(t_i)=I\Big(PAIN(t_i)>\frac{1}{n_{t_i}}\sum_{t_i=1}^{n_{t_i}}PAIN(t_i)\Big)
$$
Then define the RPE given $A(t_i)=1$ for person $i$ on day $t_i$. 

$$
RPE(t_i)=I\Big(PAIN(t_i)\leq \frac{1}{n_{t_i}}\sum_{t_i=1}^{n_{t_i}}PAIN(t_i)\Big)\times A(t_i-1)
$$

```{r, echo = TRUE, results = 'hide'}
## RPE Index using within person mean
data_paper2 <- data_paper2 |>
  group_by(ID) |>
  mutate(AVE = mean(IndexLev1_PainAverage, na.rm = TRUE),
         A = ifelse(IndexLev1_PainAverage > AVE, 1, 0),
         A_lag = lag(A),
         Lev1_RPE_useMean = ifelse(A_lag == 1, 
                                   ifelse(IndexLev1_PainAverage <= AVE, 1, 0), 0)) 

###### Check ######
data_paper2_check <- data_paper2 |>
  select(c(ID, Wave_Day_Adjusted, IndexLev1_PainAverage, IndexLev1_PainAverage_Lagged, 
           AVE, A, A_lag, Lev1_RPE_useMean))
# 203 RPEs
  
```

For calculating the RPE based on the APE, 

$$
RPE(t_i)=I\Big(PAIN(t_i)\leq \frac{1}{n_{t_i}}\sum_{t_i=1}^{n_{t_i}}PAIN(t_i)\Big)\times APE(t_i-1)
$$

```{r, echo = TRUE, results = 'hide'}
## RPE Index using APE
data_paper2 <- data_paper2 |>
  group_by(ID) |>
  mutate(APE_lag = lag(APE), 
         Lev1_RPE_useAPE = ifelse(APE_lag == 1, 
                                   ifelse(IndexLev1_PainAverage <= 20, 1, 0), 0)) 

###### Check ######
data_paper2_check <- data_paper2 |>
  select(c(ID, Wave_Day_Adjusted, IndexLev1_PainAverage, IndexLev1_PainAverage_Lagged, 
           APE, APE_lag, Lev1_RPE_useAPE))
# 4 RPEs
```

## Analysis of APE using the Table in the Manuscript

```{r, echo = TRUE, results = 'hide'}
## Unadjusted APE to Negative Affect
model_APE.NA <- glmer(APE ~ IndexLev1_NegativeAffect_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.NA)

 ## Unadjusted APE to Catastrophizing
model_APE.Cata <- glmer(APE ~ IndexLev1_Catastrophizing_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.Cata)

## Unadjusted APE to PPThs
model_APE.PPThs <- glmer(APE ~ IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.PPThs)

## Unadjusted APE to TSP
model_APE.TSP <- glmer(APE ~ IndexLev2_QST_TSPAve + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.TSP)

## Unadjusted APE to CPM
model_APE.CPM <- glmer(APE ~ IndexLev2_QST_CpmTrialAve + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.CPM)
```

```{r, echo = TRUE, results = 'hide'}
## Adjusted APE
model_APE <- glmer(APE ~ IndexLev1_Catastrophizing_Total + IndexLev1_NegativeAffect_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE)

model_APE_2 <- glmer(APE ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE_2)
```

## Analysis of RPE using the Table of Manuscript

```{r, echo = TRUE, results = 'hide'}
## Unadjusted RPE to Negative Affect
model_RPE.NA <- glmer(Lev1_RPE_useMean ~ IndexLev1_NegativeAffect_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.NA)

 ## Unadjusted RPE to Catastrophizing
model_RPE.Cata <- glmer(Lev1_RPE_useMean ~ IndexLev1_Catastrophizing_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.Cata)

## Unadjusted RPE to PPThs
model_RPE.PPThs <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.PPThs)

## Unadjusted RPE to TSP
model_RPE.TSP <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_TSPAve + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.TSP)

## Unadjusted RPE to CPM
model_RPE.CPM <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_CpmTrialAve + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.CPM)
```

```{r, echo = TRUE, results = 'hide'}
## Adjusted RPE
model_RPE <- glmer(Lev1_RPE_useMean ~  IndexLev1_Catastrophizing_Total + IndexLev1_NegativeAffect_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE)

model_RPE_2 <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE_2)
```

## Adjusting more confounding factors

```{r, echo = TRUE, results = 'hide'}
## Consider age, sex, BMI,... (Lvl2) for APE
model_APE_2_conf <- glmer(APE ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + Baseline_Demog_Ethnicity + Baseline_Demog_Age + Baseline_Demog_BMI + Baseline_Demog_Sex + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE_2_conf)

## Consider age, sex, BMI,... (Lvl2) for RPE
model_RPE_2_conf <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + Baseline_Demog_Ethnicity + Baseline_Demog_Age + Baseline_Demog_BMI + Baseline_Demog_Sex + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE_2_conf)
```

These seem to have no confounding effects... 

## Lev1 and Lev2 Together for APE and RPE

```{r, echo = TRUE, results = 'hide'}
model_APE_conf <- glmer(APE ~ IndexLev1_Catastrophizing_Total + IndexLev1_NegativeAffect_Total + Level1_Even_PhysActiv + IndexLev2_QST_CpmTrialAve + Wave_Day + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE_conf)

model_RPE_conf <- glmer(Lev1_RPE_useMean ~ IndexLev1_Catastrophizing_Total + IndexLev1_NegativeAffect_Total + Level1_Even_PhysActiv + IndexLev2_QST_CpmTrialAve + Wave_Day + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE_conf)
```

According to the meeting with Dr. Marc O. Martel on Apr. 12, the above results are not sufficient. 

\newpage

## Results after Apr. 12

```{r}
## Day-to-day delta change score in pain (From yesterday to today), check normality
ggplot(data_paper2, aes(x = IndexLev1_PainAverage_RawChange)) + 
  geom_density() +
  geom_vline(aes(xintercept = mean(IndexLev1_PainAverage_RawChange, na.rm = TRUE)), 
             color = "red", linetype = "dashed", size = 1) + # 1399 out of 2212 have missing
  labs(title = "Global density of Pain delta changes", 
       x = "Pain Delta Change", 
       y = "Density") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) # It looks normal to me 

## Shapiro test (Formal test of normality)
normal_check <- data_paper2$IndexLev1_PainAverage_RawChange[!is.na(data_paper2$IndexLev1_PainAverage_RawChange)]
shapiro.test(normal_check) # Although the formal test does not suggest normality
```

The below will examine if baseline covairates are associated with the delta pain change individually. 

```{r}
## Age
model_age <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Demog_Age + (1|ID), data = data_paper2)
summary(model_age)

## Sex
model_sex <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Demog_Sex + (1|ID), data = data_paper2)
summary(model_sex)

## BMI
model_bmi <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Demog_BMI + (1|ID), data = data_paper2)
summary(model_bmi)

## Ethnicity
model_ethn <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Demog_Ethnicity_Rec + (1|ID), data = data_paper2)
summary(model_ethn)

## SmokePerday
model_smoke <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Lifestyle_SmokePerday + (1|ID), data = data_paper2)
summary(model_smoke)

## Meds_Acetaminophen
model_acetam <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Acetaminophen + (1|ID), data = data_paper2)
summary(model_acetam)

## NSAID
model_NSAID <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_NSAID + (1|ID), data = data_paper2)
summary(model_NSAID)

## Cox2
model_cox2 <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Cox2 + (1|ID), data = data_paper2)
summary(model_cox2)

## Antidepressants
model_antidep <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Antidepressants + (1|ID), data = data_paper2)
summary(model_antidep)

## Baseline_Meds_Anxiolytics
model_anxioly <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Anxiolytics + (1|ID), data = data_paper2)
summary(model_anxioly)

## MuscleRelaxants
model_musclerelax <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_MuscleRelaxants + (1|ID), data = data_paper2)
summary(model_musclerelax)

## Baseline_Meds_Opioids
model_opioid <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Opioids + (1|ID), data = data_paper2)
summary(model_opioid)

## Baseline_Meds_Anticonvulsants
model_anticonv <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Anticonvulsants + (1|ID), data = data_paper2)
summary(model_anticonv)
```

## Level 2 covariates

The below will examine if PPTh, TSP, and CPM are significantly associated with the delta pain change. 

```{r}
## PPTh
model_PPTh <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_BaselinePPTh + (1|ID), data = data_paper2)
summary(model_PPTh)

## TSP 
model_TSP <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_TSPAve + (1|ID), data = data_paper2)
summary(model_TSP)

## CPM
model_CPM <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_CpmTrialAve + (1|ID), data = data_paper2)
summary(model_CPM)

## Adjusted model
model_adjusted_lev2 <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), data = data_paper2)
summary(model_adjusted_lev2)
```

## Level 1 covariates

The following will examine if DailyCatastro, DailyNA, Daily PosAffect, DailyPhysExcersice are associated with the delta change in pain

```{r}
## Daily Catastro
model_catastro <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_catastro) # Significant!

## DailyNA
model_DailyNA <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2)
summary(model_DailyNA) # Significant!

## PosAffect
model_PosAffect <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev1_PositiveAffect_Total + (1|ID), data = data_paper2)
summary(model_PosAffect)

## DailyPhysExcersice
model_PhysExercise <- lmer(IndexLev1_PainAverage_RawChange ~ Level1_Even_PhysActiv + (1|ID), data = data_paper2)
summary(model_PhysExercise) # Significant! 

## Adjusted level 1
model_adj_lev1 <- lmer(IndexLev1_PainAverage_RawChange ~ Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_adj_lev1) # Catastro significant! 

## Both level 1 and level 2
model_adj_all <- lmer(IndexLev1_PainAverage_RawChange ~ Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), data = data_paper2)
summary(model_adj_all)
```

The following code will examine the count of the APEs per individual using Poisson regression

```{r}
library(pscl)
data_paper2_pois <- data_paper2 |>
  select(c(Baseline_Demog_Age, Baseline_Demog_Sex, 
           Baseline_Demog_BMI, Baseline_Demog_Ethnicity_Rec, 
           Baseline_Lifestyle_SmokePerday, Baseline_Meds_Acetaminophen, 
           Baseline_Meds_NSAID, Baseline_Meds_Cox2, 
           Baseline_Meds_Antidepressants, Baseline_Meds_Anxiolytics,
           Baseline_Meds_MuscleRelaxants, Baseline_Meds_Opioids, 
           Baseline_Meds_Anticonvulsants, IndexLev2_QST_BaselinePPTh, 
           IndexLev2_QST_TSPAve, IndexLev2_QST_CpmTrialAve, APE, ID))
data_paper2_pois2 <- data_paper2_pois |>
  group_by(ID) |>
  summarise(nAPE = sum(APE, na.rm = TRUE)) 
data_paper2_pois <- merge(data_paper2_pois, data_paper2_pois2, by = "ID")
data_paper2_pois <- data_paper2_pois |>
  group_by(ID) |>
  slice(1) |>
  ungroup()

zinb_model <- zeroinfl(nAPE ~ Baseline_Demog_Age + Baseline_Demog_Sex + 
           Baseline_Demog_BMI + Baseline_Demog_Ethnicity_Rec + 
           Baseline_Lifestyle_SmokePerday + IndexLev2_QST_BaselinePPTh + 
           IndexLev2_QST_TSPAve + IndexLev2_QST_CpmTrialAve, data = data_paper2_pois)
summary(zinb_model)

```















