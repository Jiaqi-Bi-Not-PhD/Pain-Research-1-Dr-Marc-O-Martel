---
title: "Martel Paper - Daily OA Pain"
date: "2024-03-18"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
urlcolor: blue
header-includes:    
  - \usepackage{lastpage}
  - \usepackage{fancyhdr}
  - \usepackage{setspace}
  - \usepackage{float}
  - \pagestyle{fancy}
  - \fancyhead[CO, CE]{Jiaqi Bi}
  - \fancyhead[LE, RO]{Martel - Daily OA Pain}
  - \fancyfoot[CO, CE]{\thepage \ of \pageref{LastPage}}
  - \floatplacement{figure}{H}
mainfont: Times New Roman
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packges

```{r, warning = FALSE, message = FALSE}
## Load packages
library(tidyverse)
library(ggplot2)
library(tidyr)
library(haven)## This library provides functions to read sav file into R
library(lme4)
library(lmerTest)
library(performance)
```

# Dataset Preparation/Cleanup

```{r, message = FALSE}
## Read data
data_paper <- read_sav("Dataset; 2024.1.sav")
checkdf3 <- data_paper |> 
  subset(ID == 2072) |> 
  select(c(ID, 
           Level1_Even_DateIn, 
           Level1_Even_TimeIn,
           Wave_Day))

## Delete Weird ID 2072 those weird reporting days
data_paper <- data_paper |>
  filter(!(ID == 2072 & Wave_Day >= 7))
```

### Adjusting Wave Day 

\begin{itemize}
  \item $DT_i$ combines $D_i$ and $T_i$: `DateTime` variable
  \item $DT_0$ is the first response `DateTime` for each patient
  \item $W_i$ is the adjusted `Wave\_Day` variable
  \item Add a grace period $G$ for calculating the adjusted $W_i$, in our case $G=6$ hours
  \item Calculate the datetime difference $H_i$ in **hours** from the first response, incorporating the grace period:
  $$
  H_i = DT_i-DT_{i-1}
  $$
  \item Then apply the grace period indicator $I_i$:
  $$
  I_i=
  \begin{cases}
  1 & \text{if } H_{i} \leq 24 + G \\
  \left\lceil\frac{H_{i} - G}{24}\right\rceil & \text{otherwise}
  \end{cases}
  $$
  \item The initial response for `Wave\_Day` is 1, i.e., $W_0=1$, then the adjusted `Wave\_Day` $W_i$ is 
  $$
  W_i=\sum_{i=0}^{i-1} I_i
  $$
\end{itemize}


```{r, message = FALSE}
## Consecutive Days - Grace Period 6 hours
data_paper <- data_paper |>
  mutate(Lev1_DateTimeIn = as.POSIXct(strptime(paste(Level1_Even_DateIn, 
                                                     Level1_Even_TimeIn), 
                                          format="%Y-%m-%d %H:%M:"))) |>
  arrange(ID, Lev1_DateTimeIn) |>
  group_by(ID) |>
  mutate(
    TimeDiffHours = as.numeric(difftime(Lev1_DateTimeIn, 
                                        lag(Lev1_DateTimeIn, 
                                            default = first(Lev1_DateTimeIn)), 
                                        units = "hours")), # T diff
    WithinGracePeriod = if_else(TimeDiffHours <= 30, 
                                1, 
                                ceiling((TimeDiffHours - 6) / 24)), # Check grace period
    Wave_Day_Adjusted = cumsum(WithinGracePeriod) # Adjusted Wave_Day
  ) |>
  ungroup()

###### Check if the above approach is correct ######
checkdf <- data_paper |> select(c(ID, 
                                  Lev1_DateTimeIn, 
                                  TimeDiffHours, 
                                  WithinGracePeriod, 
                                  Wave_Day_Adjusted,
                                  Baseline_Demog_BMI))
checkdf2 <- checkdf |> subset(ID == 2072) # Weird ID 2072
max(checkdf$Wave_Day_Adjusted, na.rm = TRUE) 

```




```{r, message = FALSE}
## Fill in the gap of Wave_Day
data_paper2 <- data_paper |>
  group_by(ID) |>
  complete(Wave_Day = 1:14) |>
  ungroup()

data_paper2 <- data_paper2 |>
  mutate(Level1_Even_Percent_Transf = Level1_Even_Percent/100)

adjustments <- 0.0001
data_paper2 <- data_paper2 |>
  mutate(Level1_Even_Percent_Transf = ifelse(Level1_Even_Percent_Transf != 0, ifelse(Level1_Even_Percent_Transf == 1, Level1_Even_Percent_Transf - adjustments, Level1_Even_Percent_Transf), Level1_Even_Percent_Transf + adjustments))
```

```{r, message = FALSE, echo = TRUE, results = 'hide'}
## Check the aberrant values
summary(data_paper2$IndexLev1_NegativeAffect_Total) # Lev 1 Negative Affect 
summary(data_paper2$IndexLev1_Catastrophizing_Total) # Lev 1 Catas
summary(data_paper2$IndexLev2_QST_BaselinePPTh) # Lev 2 PPThs?
summary(data_paper2$IndexLev2_QST_TSPAve) # Lev 2 TSP?
summary(data_paper2$IndexLev2_QST_CpmTrialAve) # Lev 2 CPM?
summary(data_paper2$IndexLev1_PainAverage) # Lev 1 Pain?

###### Check if lagged value is correct ######
data_paper2_check <- data_paper2 |>
  select(c(ID, Wave_Day_Adjusted, IndexLev1_PainAverage, IndexLev1_PainAverage_Lagged))
```

$$
APE(t_i)=I(PAIN(t_i)-PAIN(t_i-1) \geq 20)
$$

```{r, results = 'hide', echo = TRUE}
## APE index
data_paper2 <- data_paper2 |>
  group_by(ID) |>
  mutate(APE = ifelse(IndexLev1_PainAverage - IndexLev1_PainAverage_Lagged >= 20, 1, 0))

###### Check if it is correctly coded ######
data_paper2_check <- data_paper2 |>
  select(c(ID, Wave_Day_Adjusted, 
           IndexLev1_PainAverage, 
           IndexLev1_PainAverage_Lagged, 
           APE))
```

For calculating the RPE based on the within person mean, define the indicator that the pain is above the average pain for person $i$ on day $t_i$. Note that $n_{t_i}=\max{t_i}$ for patient $i$.

$$
A(t_i)=I\Big(PAIN(t_i)>\frac{1}{n_{t_i}}\sum_{t_i=1}^{n_{t_i}}PAIN(t_i)\Big)
$$
Then define the RPE given $A(t_i)=1$ for person $i$ on day $t_i$. 

$$
RPE(t_i)=I\Big(PAIN(t_i)\leq \frac{1}{n_{t_i}}\sum_{t_i=1}^{n_{t_i}}PAIN(t_i)\Big)\times A(t_i-1)
$$

```{r, echo = TRUE, results = 'hide'}
## RPE Index using within person mean
data_paper2 <- data_paper2 |>
  group_by(ID) |>
  mutate(AVE = mean(IndexLev1_PainAverage, na.rm = TRUE),
         A = ifelse(IndexLev1_PainAverage > AVE, 1, 0),
         A_lag = lag(A),
         Lev1_RPE_useMean = ifelse(A_lag == 1, 
                                   ifelse(IndexLev1_PainAverage <= AVE, 1, 0), 0)) 

###### Check ######
data_paper2_check <- data_paper2 |>
  select(c(ID, Wave_Day_Adjusted, IndexLev1_PainAverage, IndexLev1_PainAverage_Lagged, 
           AVE, A, A_lag, Lev1_RPE_useMean))
# 203 RPEs
  
```

For calculating the RPE based on the APE, 

$$
RPE(t_i)=I\Big(PAIN(t_i)\leq \frac{1}{n_{t_i}}\sum_{t_i=1}^{n_{t_i}}PAIN(t_i)\Big)\times APE(t_i-1)
$$

```{r, echo = TRUE, results = 'hide'}
## RPE Index using APE
data_paper2 <- data_paper2 |>
  group_by(ID) |>
  mutate(APE_lag = lag(APE), 
         Lev1_RPE_useAPE = ifelse(APE_lag == 1, 
                                   ifelse(IndexLev1_PainAverage <= 20, 1, 0), 0)) 

###### Check ######
data_paper2_check <- data_paper2 |>
  select(c(ID, Wave_Day_Adjusted, IndexLev1_PainAverage, IndexLev1_PainAverage_Lagged, 
           APE, APE_lag, Lev1_RPE_useAPE))
# 4 RPEs
```

## Analysis of APE using the Table in the Manuscript

```{r, echo = TRUE, results = 'hide'}
## Unadjusted APE to Negative Affect
model_APE.NA <- glmer(APE ~ IndexLev1_NegativeAffect_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.NA)
confint(model_APE.NA, method = "Wald")
exp(c(-3.7693732604, -2.47970059))
exp(c(0.0005436968,  0.02779017))

 ## Unadjusted APE to Catastrophizing
model_APE.Cata <- glmer(APE ~ IndexLev1_Catastrophizing_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.Cata)
confint(model_APE.Cata, method = "Wald")
exp(c(-3.873536895, -2.63107008))
exp(c(0.007696443,  0.03034345))

## Unadjusted APE to PPThs
model_APE.PPThs <- glmer(APE ~ IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.PPThs)
confint(model_APE.PPThs, method = "Wald")
exp(c(-2.538915930, -1.057235635))
exp(c(-0.003987894, -0.000407614))

## Unadjusted APE to TSP
model_APE.TSP <- glmer(APE ~ IndexLev2_QST_TSPAve + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.TSP)
confint(model_APE.TSP, method = "Wald")
exp(c(-2.88049068, -1.926912039))
exp(c(-0.03821397,  0.002116432))

## Unadjusted APE to CPM
model_APE.CPM <- glmer(APE ~ IndexLev2_QST_CpmTrialAve + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE.CPM)
confint(model_APE.CPM, method = "Wald")
exp(c(-4.233033049, -1.55813896))
exp(c(-0.008342697,  0.01150198))

```

```{r, echo = TRUE, results = 'hide'}
## Adjusted APE Level 1 Variables
model_APE <- glmer(APE ~ IndexLev1_Catastrophizing_Total + IndexLev1_NegativeAffect_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE)
confint(model_APE, method = "Wald")
exp(c(-4.040986071, -2.61289642))
exp(c(0.004962518,  0.03030470))
exp(c(-0.011965205,  0.01950413))

## Adjusted APE Level 2 Variables
model_APE_2 <- glmer(APE ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE_2)
confint(model_APE_2, method = "Wald")
exp(c(-2.423626853,  0.8228091452))
exp(c(-0.012036593,  0.0068773733))
exp(c(-0.045874417, -0.0042397835))
exp(c(-0.004730055, -0.0008967555))

## Adjusted APE Level 1 and Level 2
model_APE_1and2 <- glmer(APE ~ IndexLev1_Catastrophizing_Total + IndexLev1_NegativeAffect_Total + IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE_1and2)
icc(model_APE_1and2)
```

## Analysis of RPE using the Table of Manuscript

```{r, echo = TRUE, results = 'hide'}
## Unadjusted RPE to Negative Affect
model_RPE.NA <- glmer(Lev1_RPE_useMean ~ IndexLev1_NegativeAffect_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.NA)

 ## Unadjusted RPE to Catastrophizing
model_RPE.Cata <- glmer(Lev1_RPE_useMean ~ IndexLev1_Catastrophizing_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.Cata)

## Unadjusted RPE to PPThs
model_RPE.PPThs <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.PPThs)

## Unadjusted RPE to TSP
model_RPE.TSP <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_TSPAve + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.TSP)

## Unadjusted RPE to CPM
model_RPE.CPM <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_CpmTrialAve + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE.CPM)
```

```{r, echo = TRUE, results = 'hide'}
## Adjusted RPE
model_RPE <- glmer(Lev1_RPE_useMean ~  IndexLev1_Catastrophizing_Total + IndexLev1_NegativeAffect_Total + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE)

model_RPE_2 <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE_2)
```

## Adjusting more confounding factors

```{r, echo = TRUE, results = 'hide'}
## Consider age, sex, BMI,... (Lvl2) for APE
model_APE_2_conf <- glmer(APE ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + Baseline_Demog_Ethnicity + Baseline_Demog_Age + Baseline_Demog_BMI + Baseline_Demog_Sex + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE_2_conf)

## Consider age, sex, BMI,... (Lvl2) for RPE
model_RPE_2_conf <- glmer(Lev1_RPE_useMean ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + Baseline_Demog_Ethnicity + Baseline_Demog_Age + Baseline_Demog_BMI + Baseline_Demog_Sex + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE_2_conf)
```

These seem to have no confounding effects... 

## Lev1 and Lev2 Together for APE and RPE

```{r, echo = TRUE, results = 'hide'}
model_APE_conf <- glmer(APE ~ IndexLev1_Catastrophizing_Total + IndexLev1_NegativeAffect_Total + Level1_Even_PhysActiv + IndexLev2_QST_CpmTrialAve + Wave_Day + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_APE_conf)

model_RPE_conf <- glmer(Lev1_RPE_useMean ~ IndexLev1_Catastrophizing_Total + IndexLev1_NegativeAffect_Total + Level1_Even_PhysActiv + IndexLev2_QST_CpmTrialAve + Wave_Day + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = binomial(), data = data_paper2)
summary(model_RPE_conf)
```

According to the meeting with Dr. Marc O. Martel on Apr. 12, the above results are not sufficient. 

\newpage

## Results after Apr. 12

```{r}
## Day-to-day delta change score in pain (From yesterday to today), check normality
ggplot(data_paper2, aes(x = IndexLev1_PainAverage_RawChange)) + 
  geom_density() +
  geom_vline(aes(xintercept = mean(IndexLev1_PainAverage_RawChange, na.rm = TRUE)), 
             color = "red", linetype = "dashed", size = 1) + # 1399 out of 2212 have missing
  labs(title = "Global density of Pain delta changes", 
       x = "Pain Delta Change", 
       y = "Density") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) # It looks normal to me 

## Shapiro test (Formal test of normality)
normal_check <- data_paper2$IndexLev1_PainAverage_RawChange[!is.na(data_paper2$IndexLev1_PainAverage_RawChange)]
shapiro.test(normal_check) # Although the formal test does not suggest normality
```

The below will examine if baseline covariates are associated with the delta pain change individually. 

```{r}
## Age
model_age <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Demog_Age + (1|ID), data = data_paper2)
summary(model_age)
confint(model_age, method = "Wald")

## Sex
model_sex <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Demog_Sex + (1|ID), data = data_paper2)
summary(model_sex)
confint(model_sex, method = "Wald")

## BMI
model_bmi <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Demog_BMI + (1|ID), data = data_paper2)
summary(model_bmi)
confint(model_bmi, method = "Wald")

## Ethnicity
model_ethn <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Demog_Ethnicity_Rec + (1|ID), data = data_paper2)
summary(model_ethn)
confint(model_ethn, method = "Wald")

## SmokePerday
model_smoke <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Lifestyle_SmokePerday + (1|ID), data = data_paper2)
summary(model_smoke)
confint(model_smoke, method = "Wald")

## Meds_Acetaminophen
model_acetam <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Acetaminophen + (1|ID), data = data_paper2)
summary(model_acetam)
confint(model_acetam, method = "Wald")

## NSAID
model_NSAID <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_NSAID + (1|ID), data = data_paper2)
summary(model_NSAID)
confint(model_NSAID, method = "Wald")

## Cox2
model_cox2 <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Cox2 + (1|ID), data = data_paper2)
summary(model_cox2)
confint(model_cox2, method = "Wald")

## Antidepressants
model_antidep <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Antidepressants + (1|ID), data = data_paper2)
summary(model_antidep)
confint(model_antidep, method = "Wald")

## Baseline_Meds_Anxiolytics
model_anxioly <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Anxiolytics + (1|ID), data = data_paper2)
summary(model_anxioly)
confint(model_anxioly, method = "Wald")

## MuscleRelaxants
model_musclerelax <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_MuscleRelaxants + (1|ID), data = data_paper2)
summary(model_musclerelax)
confint(model_musclerelax, method = "Wald")

## Baseline_Meds_Opioids
model_opioid <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Opioids + (1|ID), data = data_paper2)
summary(model_opioid)
confint(model_opioid, method = "Wald")

## Baseline_Meds_Anticonvulsants
model_anticonv <- lmer(IndexLev1_PainAverage_RawChange ~ Baseline_Meds_Anticonvulsants + (1|ID), data = data_paper2)
summary(model_anticonv)
confint(model_anticonv, method = "Wald")
```

## Level 2 covariates

The below will examine if PPTh, TSP, and CPM are significantly associated with the delta pain change. 

```{r}
## PPTh
model_PPTh <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_BaselinePPTh + (1|ID), data = data_paper2)
summary(model_PPTh)
confint(model_PPTh, method = "Wald")


## TSP 
model_TSP <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_TSPAve + (1|ID), data = data_paper2)
summary(model_TSP)
confint(model_TSP, method = "Wald")

## CPM
model_CPM <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_CpmTrialAve + (1|ID), data = data_paper2)
summary(model_CPM)
confint(model_CPM, method = "Wald")

## Adjusted model
model_adjusted_lev2 <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), data = data_paper2)
summary(model_adjusted_lev2)
confint(model_adjusted_lev2, method = "Wald")
```

## Level 1 covariates

The following will examine if DailyCatastro, DailyNA, Daily PosAffect, DailyPhysExcersice are associated with the delta change in pain

```{r}
## Daily Catastro
model_catastro <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_catastro) # Significant!
confint(model_catastro, method = "Wald")

## DailyNA
model_DailyNA <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2)
summary(model_DailyNA) # Significant!
confint(model_DailyNA, method = "Wald")

## PosAffect
model_PosAffect <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev1_PositiveAffect_Total + (1|ID), data = data_paper2)
summary(model_PosAffect)
confint(model_PosAffect, method = "Wald")

## DailyPhysExcersice
model_PhysExercise <- lmer(IndexLev1_PainAverage_RawChange ~ Level1_Even_PhysActiv + (1|ID), data = data_paper2)
summary(model_PhysExercise) # Significant! 
confint(model_PhysExercise, method = "Wald")

## Adjusted level 1
model_adj_lev1 <- lmer(IndexLev1_PainAverage_RawChange ~ Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_adj_lev1) # Catastro significant! 
confint(model_adj_lev1, method = "Wald")

## Both level 1 and level 2
model_adj_all <- lmer(IndexLev1_PainAverage_RawChange ~ Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), data = data_paper2)
summary(model_adj_all)
confint(model_adj_all, method = "Wald")

summary(data_paper2$IndexLev1_PainAverage_RawChange)
icc(model_adj_all)



```

The following code will examine the count of the APEs per individual using Poisson regression

```{r}
library(pscl)
data_paper2_pois <- data_paper2 |>
  select(c(Baseline_Demog_Age, Baseline_Demog_Sex, 
           Baseline_Demog_BMI, Baseline_Demog_Ethnicity_Rec, 
           Baseline_Lifestyle_SmokePerday, Baseline_Meds_Acetaminophen, 
           Baseline_Meds_NSAID, Baseline_Meds_Cox2, 
           Baseline_Meds_Antidepressants, Baseline_Meds_Anxiolytics,
           Baseline_Meds_MuscleRelaxants, Baseline_Meds_Opioids, 
           Baseline_Meds_Anticonvulsants, IndexLev2_QST_BaselinePPTh, 
           IndexLev2_QST_TSPAve, IndexLev2_QST_CpmTrialAve, APE, ID))
data_paper2_pois2 <- data_paper2_pois |>
  group_by(ID) |>
  summarise(nAPE = sum(APE, na.rm = TRUE)) 
data_paper2_pois <- merge(data_paper2_pois, data_paper2_pois2, by = "ID")
data_paper2_pois <- data_paper2_pois |>
  group_by(ID) |>
  slice(1) |>
  ungroup()

zinb_model <- zeroinfl(nAPE ~ Baseline_Demog_Age + Baseline_Demog_Sex + 
           Baseline_Demog_BMI + Baseline_Demog_Ethnicity_Rec + 
           Baseline_Lifestyle_SmokePerday + IndexLev2_QST_BaselinePPTh + 
           IndexLev2_QST_TSPAve + IndexLev2_QST_CpmTrialAve, data = data_paper2_pois)
zinb_model_TSP <- zeroinfl(nAPE ~ IndexLev2_QST_TSPAve, data = data_paper2_pois)
zinb_model_PPTh <- zeroinfl(nAPE ~ IndexLev2_QST_BaselinePPTh, data = data_paper2_pois)
summary(zinb_model_PPTh)
summary(zinb_model_TSP)
summary(zinb_model)

pois_model <- glm(nAPE ~ Baseline_Demog_Age + Baseline_Demog_Sex + 
           Baseline_Demog_BMI + Baseline_Demog_Ethnicity_Rec + 
           Baseline_Lifestyle_SmokePerday + IndexLev2_QST_BaselinePPTh + 
           IndexLev2_QST_TSPAve + IndexLev2_QST_CpmTrialAve, data = data_paper2_pois, family = poisson())
summary(pois_model)
           


```


```{r}
## Daily Pain intensity average as outcome - Outcome IndexLev1_PainAverage
## Age
model_painave_age <- lmer(IndexLev1_PainAverage ~ Baseline_Demog_Age + (1|ID), data = data_paper2)
summary(model_painave_age) #Significant
confint(model_painave_age, method = "Wald")
icc(model_painave_age)
## Sex
model_painave_sex <- lmer(IndexLev1_PainAverage ~ Baseline_Demog_Sex + (1|ID), data = data_paper2)
summary(model_painave_sex)
confint(model_painave_sex, method = "Wald")
icc(model_painave_sex)
## BMI
model_painave_BMI <- lmer(IndexLev1_PainAverage ~ Baseline_Demog_BMI + (1|ID), data = data_paper2)
summary(model_painave_BMI)#Significant
confint(model_painave_BMI, method = "Wald")
icc(model_painave_BMI)
## Ethnicity
model_painave_eth <- lmer(IndexLev1_PainAverage ~ Baseline_Demog_Ethnicity_Rec + (1|ID), data = data_paper2)
summary(model_painave_eth)
confint(model_painave_eth, method = "Wald")
icc(model_painave_eth)
## Smoke per day
model_painave_smoke <- lmer(IndexLev1_PainAverage ~ Baseline_Lifestyle_SmokePerday + (1|ID), data = data_paper2)
summary(model_painave_smoke)
confint(model_painave_smoke, method = "Wald")
icc(model_painave_smoke)
## Acetaminophen
model_painave_ace <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_Acetaminophen + (1|ID), data = data_paper2)
summary(model_painave_ace)
confint(model_painave_ace, method = "Wald")
icc(model_painave_ace)
## NSAID
model_painave_NSAID <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_NSAID + (1|ID), data = data_paper2)
summary(model_painave_NSAID)#Significant
confint(model_painave_NSAID, method = "Wald")
icc(model_painave_NSAID)
## Cox2
model_painave_cox2 <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_Cox2 + (1|ID), data = data_paper2)
summary(model_painave_cox2)
confint(model_painave_cox2, method = "Wald")
icc(model_painave_cox2)
## Antidepressant
model_painave_antidep <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_Antidepressants + (1|ID), data = data_paper2)
summary(model_painave_antidep)
confint(model_painave_antidep, method = "Wald")
icc(model_painave_antidep)
## Anxiolytics
model_painave_anxio <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_Anxiolytics + (1|ID), data = data_paper2)
summary(model_painave_anxio)
confint(model_painave_anxio, method = "Wald")
icc(model_painave_anxio)
## Muscle Relaxants
model_painave_muscle <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_MuscleRelaxants + (1|ID), data = data_paper2)
icc(model_painave_muscle)
summary(model_painave_muscle)
confint(model_painave_muscle, method = "Wald")
## Opioids
model_painave_opioids <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_Opioids + (1|ID), data = data_paper2)
icc(model_painave_opioids)
summary(model_painave_opioids)
confint(model_painave_opioids, method = "Wald")
## Anticonvulsants
model_painave_anticon <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_Anticonvulsants + (1|ID), data = data_paper2)
icc(model_painave_anticon)
summary(model_painave_anticon)#Significant
confint(model_painave_anticon, method = "Wald")






```

```{r}
## Main level 2 analysis - IndexLev1_PainAverage as the outcome
## IndexLev2_QST_BaselinePPTh 
model_painave_ppth <- lmer(IndexLev1_PainAverage ~ IndexLev2_QST_BaselinePPTh + (1|ID), data = data_paper2)
icc(model_painave_ppth)
summary(model_painave_ppth)
confint(model_painave_ppth, method = "Wald")
## IndexLev2_QST_TSPAve 
model_painave_TSP <- lmer(IndexLev1_PainAverage ~ IndexLev2_QST_TSPAve + (1|ID), data = data_paper2)
icc(model_painave_TSP)
summary(model_painave_TSP)
confint(model_painave_TSP, method = "Wald")
## IndexLev2_QST_CpmTrialAve
model_painave_CPM <- lmer(IndexLev1_PainAverage ~ IndexLev2_QST_CpmTrialAve + (1|ID), data = data_paper2)
icc(model_painave_CPM)
summary(model_painave_CPM)
confint(model_painave_CPM, method = "Wald")
## Adjusted
model_painave_lev2adj <- lmer(IndexLev1_PainAverage ~ IndexLev2_QST_BaselinePPTh + IndexLev2_QST_TSPAve + IndexLev2_QST_CpmTrialAve + Baseline_Demog_Age + Baseline_Demog_BMI + Baseline_Meds_NSAID + Baseline_Meds_Anticonvulsants + (1|ID), data = data_paper2)
icc(model_painave_lev2adj)
summary(model_painave_lev2adj)
confint(model_painave_lev2adj, method = "Wald")
## Adjusted with only main factors
model_painave_lev2adj_main <- lmer(IndexLev1_PainAverage ~ IndexLev2_QST_BaselinePPTh + IndexLev2_QST_TSPAve + IndexLev2_QST_CpmTrialAve + (1|ID), data = data_paper2)
icc(model_painave_lev2adj_main)
summary(model_painave_lev2adj_main)
confint(model_painave_lev2adj_main, method = "Wald")

```

```{r}
## Outcome IndexLev1_PainAverage - Level 1
## Daily Catastro
model_painave_cata <- lmer(IndexLev1_PainAverage ~  IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
icc(model_painave_cata)
summary(model_painave_cata)
confint(model_painave_cata, method = "Wald")
## Daily NA
model_painave_NA <- lmer(IndexLev1_PainAverage ~  IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2)
icc(model_painave_NA)
summary(model_painave_NA)
confint(model_painave_NA, method = "Wald")
## Daily PA
model_painave_PA <- lmer(IndexLev1_PainAverage ~  IndexLev1_PositiveAffect_Total + (1|ID), data = data_paper2)
icc(model_painave_PA)
summary(model_painave_PA)
confint(model_painave_PA, method = "Wald")
## Daily Phys Exercise
model_painave_PhyEx <- lmer(IndexLev1_PainAverage ~  Level1_Even_PhysActiv + (1|ID), data = data_paper2)
icc(model_painave_PhyEx)
summary(model_painave_PhyEx)
confint(model_painave_PhyEx, method = "Wald")
## Adjusted
model_painave_lvl1adj <- lmer(IndexLev1_PainAverage ~  Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
icc(model_painave_lvl1adj)
summary(model_painave_lvl1adj)
confint(model_painave_lvl1adj, method = "Wald")

## Level 1 and Level 2 together
model_painave_lvl1and2 <- lmer(IndexLev1_PainAverage ~ IndexLev2_QST_BaselinePPTh + IndexLev2_QST_TSPAve + IndexLev2_QST_CpmTrialAve + Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
icc(model_painave_lvl1and2)
summary(model_painave_lvl1and2)
confint(model_painave_lvl1and2, method = "Wald")
icc(model_painave_lvl1and2)
```

```{r}
## Plot the daily time spent in pain percentage
data_paper2 |>
  ggplot(aes(x = Level1_Even_Percent)) +
  geom_histogram(aes(y = ..density..)) +
  geom_density(aes(y = ..density..))

## Beta regression
library(glmmTMB)
data_paper2 <- data_paper2 |>
  mutate(Level1_Even_Percent_Transf = Level1_Even_Percent/100)

adjustments <- 0.0001
data_paper2 <- data_paper2 |>
  mutate(Level1_Even_Percent_Transf = ifelse(Level1_Even_Percent_Transf != 0, ifelse(Level1_Even_Percent_Transf == 1, Level1_Even_Percent_Transf - adjustments, Level1_Even_Percent_Transf), Level1_Even_Percent_Transf + adjustments))

## Beta regression for Level1_Even_Percent_Transf
## IndexLev2_QST_BaselinePPTh
beta_PPTh <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev2_QST_BaselinePPTh + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_PPTh)
summary(beta_PPTh)
confint(beta_PPTh, method = "Wald")
exp(c(0.008154675, 0.8440168521))
exp(c(-0.001585121, 0.0002889412))
## IndexLev2_QST_TSPAve 
beta_TSP <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev2_QST_TSPAve + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_TSP)
summary(beta_TSP)
confint(beta_TSP, method = "Wald")
exp(c(-0.198449697, 0.24899849))
exp(c(-0.001178379, 0.01749171))

## IndexLev2_QST_CpmTrialAve
beta_CPM <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev2_QST_CpmTrialAve + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_CPM)
summary(beta_CPM)
confint(beta_CPM, method = "Wald")
exp(c(-0.703915601, 0.92173256))
exp(c(-0.005913656, 0.00690423))

## Adjusted with only main factors
beta_level2_adj <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_level2_adj)
summary(beta_level2_adj)
confint(beta_level2_adj, method = "Wald")
exp(c(-0.006201108, 0.0073500749))
exp(c(-0.003835235, 0.0171577888))
exp(c(-0.001339993, 0.0008318547))

## Level 1 covariates
## Daily Catastro
beta_cata <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_Catastrophizing_Total + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_cata)
summary(beta_cata)
confint(beta_cata, method = "Wald")
exp(confint(beta_cata, method = "Wald"))

## Daily NA
beta_NA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_NegativeAffect_Total + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_NA)
summary(beta_NA)
confint(beta_NA, method = "Wald")
exp(confint(beta_NA, method = "Wald"))
## Daily PA
beta_PA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_PositiveAffect_Total + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_PA)
summary(beta_PA)
confint(beta_PA, method = "Wald")
exp(confint(beta_PA, method = "Wald"))
## Daily Phys Exercise
beta_PhysEx <- glmmTMB(Level1_Even_Percent_Transf ~ Level1_Even_PhysActiv + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_PhysEx)
summary(beta_PhysEx)
confint(beta_PhysEx, method = "Wald")
exp(confint(beta_PhysEx, method = "Wald"))
## Adjusted
beta_level1_adj <- glmmTMB(Level1_Even_Percent_Transf ~ Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_level1_adj)
summary(beta_level1_adj)
confint(beta_level1_adj, method = "Wald")
exp(confint(beta_level1_adj, method = "Wald"))

## Level 1 and Level 2 together
beta_adj_lvl1and2 <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_TSPAve + IndexLev2_QST_BaselinePPTh + Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + (1|ID), family = beta_family(), data = data_paper2, control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_adj_lvl1and2)
summary(beta_adj_lvl1and2)
confint(beta_adj_lvl1and2, method = "Wald")
exp(confint(beta_adj_lvl1and2, method = "Wald"))

## ICC
icc(beta_adj_lvl1and2)
```

This represents the multiplicative change in the odds of the response variable for a one-unit increase in the predictor (`IndexLev2_QST_CpmTrialAve`). If the slope is not significant, it indicates that the predictor does not have a significant effect on the odds of the response variable being in a higher category.


## May 14 2024

```{r}
## Check normality of distributions for 3 main outcomes
## Beta regression - Level1_Even_Percent_Transf
data_paper2 |> ggplot(aes(x = Level1_Even_Percent_Transf)) +
  geom_density(color = "darkblue", fill = "lightblue") +
  labs(title = "Percent (%) of day in pain", 
       x = "Percentage", 
       y = "Density") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

ggsave("OA Paper; Density; Percentage of the Day that suffers pain.jpeg")

## Linear regression - Pain average
ggplot(data_paper2, aes(x = IndexLev1_PainAverage)) +
  geom_density(color = "darkblue", fill = "lightblue") +
  labs(title = "Linear Regression - Pain Average", 
       x = "Pain Average", 
       y = "Density") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

ggsave("OA Paper; Density; Pain Average.jpeg")

## Linear Regression - IndexLev1_PainAverage_RawChange
ggplot(data_paper2, aes(x = IndexLev1_PainAverage_RawChange)) +
  geom_density(color = "darkblue", fill = "lightblue") +
  labs(title = "Linear Regression - Change of Pain Average", 
       x = "Change of Pain Average", 
       y = "Density") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) # Witches' hat

ggsave("OA Paper; Density; Change in Pain Average.jpeg")

```

```{r}
## Centering of Lev1 Predictors
data_paper2 <- data_paper2 |>
  mutate(cLevel1_Catastrophizing = IndexLev1_Catastrophizing_Total - IndexLev2_Agg_Catastrophizing,
         cLevel1_NegativeAffect = IndexLev1_NegativeAffect_Total - IndexLev2_Agg_NegativeAffect,
         cLevel1_PositiveAffect = IndexLev1_PositiveAffect_Total - IndexLev2_Agg_PositiveAffect,
         cLevel1_PhysicalActiv = Level1_Even_PhysActiv - IndexLev2_Agg_PhysicallyActiv)

## Centering of Lev2 predictors
means <- data_paper2 |>
  group_by(ID) |>
  summarise(PPTh_first = mean(IndexLev2_QST_BaselinePPTh, na.rm = TRUE),
            TSP_first = mean(IndexLev2_QST_TSPAve, na.rm = TRUE), 
            CPM_first = mean(IndexLev2_QST_CpmTrialAve, na.rm = TRUE)) |>
  summarise(PPTh_mean = mean(PPTh_first, na.rm = TRUE), 
            TSP_mean = mean(TSP_first, na.rm = TRUE), 
            CPM_mean = mean(CPM_first, na.rm = TRUE))

data_paper2 <- data_paper2 |>
  mutate(cLevel2_PPTh = IndexLev2_QST_BaselinePPTh - means$PPTh_mean,
         cLevel2_TSP = IndexLev2_QST_TSPAve - means$TSP_mean, 
         cLevel2_CPM = IndexLev2_QST_CpmTrialAve - means$CPM_mean)
```

```{r}
## Centered scores; Confirm significant findings 
## Level 1
## Beta Regression - outcome Level1_Even_Percent_Transf
beta_level1_adj_c <- glmmTMB(Level1_Even_Percent_Transf ~ cLevel1_PhysicalActiv + cLevel1_PositiveAffect + cLevel1_NegativeAffect + cLevel1_Catastrophizing + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_level1_adj_c)
summary(beta_level1_adj_c)
confint(beta_level1_adj_c, method = "Wald")
exp(confint(beta_level1_adj_c, method = "Wald"))

## Linear regression - outcome IndexLev1_PainAverage
model_painave_c <- lmer(IndexLev1_PainAverage ~  cLevel1_PhysicalActiv + cLevel1_PositiveAffect + cLevel1_NegativeAffect + cLevel1_Catastrophizing + (1|ID), data = data_paper2)
icc(model_painave_c)
summary(model_painave_c)
confint(model_painave_c, method = "Wald")

model_painave_c_NA <- lmer(IndexLev1_PainAverage ~ cLevel1_NegativeAffect + (1|ID), data = data_paper2)
summary(model_painave_c_NA)
confint(model_painave_c_NA, method = "Wald")

model_painave_c_PA <- lmer(IndexLev1_PainAverage ~ cLevel1_PositiveAffect + (1|ID), data = data_paper2)
summary(model_painave_c_PA)
confint(model_painave_c_PA, method = "Wald")

model_painave_c_Cata <- lmer(IndexLev1_PainAverage ~ cLevel1_Catastrophizing + (1|ID), data = data_paper2)
summary(model_painave_c_Cata)
confint(model_painave_c_Cata, method = "Wald")

## Linear regression - outcome IndexLev1_PainAverage_RawChange
model_adj_lev1_c <- lmer(IndexLev1_PainAverage_RawChange ~ cLevel1_PhysicalActiv + cLevel1_PositiveAffect + cLevel1_NegativeAffect + cLevel1_Catastrophizing + (1|ID), data = data_paper2)
summary(model_adj_lev1_c)
confint(model_adj_lev1_c, method = "Wald")

model_adj_lev1_c_Phys <- lmer(IndexLev1_PainAverage_RawChange ~ cLevel1_PhysicalActiv + (1|ID), data = data_paper2)
summary(model_adj_lev1_c_Phys)
confint(model_adj_lev1_c_Phys, method = "Wald")

model_adj_lev1_c_NA <- lmer(IndexLev1_PainAverage_RawChange ~  cLevel1_NegativeAffect + (1|ID), data = data_paper2)
summary(model_adj_lev1_c_NA) 
confint(model_adj_lev1_c_NA, method = "Wald")

model_adj_lev1_c_PA <- lmer(IndexLev1_PainAverage_RawChange ~  cLevel1_PositiveAffect + (1|ID), data = data_paper2)
summary(model_adj_lev1_c_PA) 
confint(model_adj_lev1_c_PA, method = "Wald")

model_adj_lev1_c_Cata <- lmer(IndexLev1_PainAverage_RawChange ~  cLevel1_Catastrophizing + (1|ID), data = data_paper2)
summary(model_adj_lev1_c_Cata) 
confint(model_adj_lev1_c_Cata, method = "Wald")


## Level 2
## Beta Regression - outcome Level1_Even_Percent_Transf
beta_level2_adj_c <- glmmTMB(Level1_Even_Percent_Transf ~ cLevel2_CPM + cLevel2_TSP + cLevel2_PPTh + (1|ID), 
                             family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
icc(beta_level2_adj_c)
summary(beta_level2_adj_c)
confint(beta_level2_adj_c, method = "Wald")
exp(confint(beta_level2_adj_c, method = "Wald"))

beta_level2_adj_c_cPPTh <- glmmTMB(Level1_Even_Percent_Transf ~ cLevel2_PPTh + (1|ID), 
                             family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_level2_adj_c_cPPTh)
confint(beta_level2_adj_c_cPPTh, method = "Wald")
exp(confint(beta_level2_adj_c_cPPTh, method = "Wald"))

beta_level2_adj_c_cTSP <- glmmTMB(Level1_Even_Percent_Transf ~ cLevel2_TSP + (1|ID), 
                             family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_level2_adj_c_cTSP)
confint(beta_level2_adj_c_cTSP, method = "Wald")
exp(confint(beta_level2_adj_c_cTSP, method = "Wald"))

beta_level2_adj_c_cCPM <- glmmTMB(Level1_Even_Percent_Transf ~ cLevel2_CPM + (1|ID), 
                             family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_level2_adj_c_cCPM)
confint(beta_level2_adj_c_cCPM, method = "Wald")
exp(confint(beta_level2_adj_c_cCPM, method = "Wald"))

beta_level2_adj_c_cNA <- glmmTMB(Level1_Even_Percent_Transf ~ cLevel1_NegativeAffect + (1|ID), 
                             family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_level2_adj_c_cNA)
confint(beta_level2_adj_c_cNA, method = "Wald")
exp(confint(beta_level2_adj_c_cNA, method = "Wald"))

beta_level2_adj_c_cPA <- glmmTMB(Level1_Even_Percent_Transf ~ cLevel1_PositiveAffect + (1|ID), 
                             family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_level2_adj_c_cPA)
confint(beta_level2_adj_c_cPA, method = "Wald")
exp(confint(beta_level2_adj_c_cPA, method = "Wald"))

beta_level2_adj_c_cCata <- glmmTMB(Level1_Even_Percent_Transf ~ cLevel1_Catastrophizing + (1|ID), 
                             family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_level2_adj_c_cCata)
confint(beta_level2_adj_c_cCata, method = "Wald")
exp(confint(beta_level2_adj_c_cCata, method = "Wald"))

beta_level2_adj_c <- glmmTMB(Level1_Even_Percent_Transf ~ cLevel1_PhysicalActiv + cLevel1_PositiveAffect +  cLevel1_NegativeAffect + cLevel1_Catastrophizing + (1|ID), 
                             family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_level2_adj_c)
confint(beta_level2_adj_c, method = "Wald")
exp(confint(beta_level2_adj_c, method = "Wald"))



## Linear regression - outcome IndexLev1_PainAverage
model_painave_lvl2c <- lmer(IndexLev1_PainAverage ~  cLevel2_CPM + cLevel2_TSP + cLevel2_PPTh + (1|ID), data = data_paper2)
icc(model_painave_lvl2c)
summary(model_painave_lvl2c)
confint(model_painave_lvl2c, method = "Wald")

## Linear regression - outcome IndexLev1_PainAverage_RawChange
model_adj_lev2_c <- lmer(IndexLev1_PainAverage_RawChange ~ cLevel2_CPM + cLevel2_TSP + cLevel2_PPTh + (1|ID), data = data_paper2)
summary(model_adj_lev2_c) 
confint(model_adj_lev2_c, method = "Wald")


```


```{r}
## Total number of Pain Location
data_paper2 <- data_paper2 |>
  mutate(IndexLev1_PainLocation_Tot = Level1_Even_PainFeet + Level1_Even_PainKnee + Level1_Even_PainLegs + Level1_Even_PainHips + Level1_Even_PainAbdom + Level1_Even_PainBack + Level1_Even_PainChest + Level1_Even_PainArms + Level1_Even_PainHands + Level1_Even_PainShoulder + Level1_Even_PainNeck + Level1_Even_PainHead)
summary(data_paper2$IndexLev1_PainLocation_Tot)

data_paper2 |> 
  ggplot(aes(x = IndexLev1_PainLocation_Tot)) +
  geom_bar()

poisson_painloc <- glmer(IndexLev1_PainLocation_Tot ~ cLevel1_PhysicalActiv + cLevel1_PositiveAffect + cLevel1_NegativeAffect + cLevel1_Catastrophizing + (1|ID), data = data_paper2, family = poisson())
summary(poisson_painloc)
```

## Effect size estimates

```{r}
library(simr)
## Effect size calculation - Daily Pain Intensity - model_painave_lvl1adj
## model_painave_lvl1adj <- lmer(IndexLev1_PainAverage ~  Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
## model_painave_lvl1and2 <- lmer(IndexLev1_PainAverage ~ IndexLev2_QST_BaselinePPTh + IndexLev2_QST_TSPAve + IndexLev2_QST_CpmTrialAve + Level1_Even_PhysActiv + IndexLev1_PositiveAffect_Total + IndexLev1_NegativeAffect_Total + IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
## model_painave_cata <- lmer(IndexLev1_PainAverage ~  IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
data_poweruse <- data_paper2 |>
  filter(across(c(IndexLev1_PainAverage, IndexLev2_QST_BaselinePPTh, IndexLev2_QST_TSPAve, IndexLev2_QST_CpmTrialAve, Level1_Even_PhysActiv, IndexLev1_PositiveAffect_Total, IndexLev1_NegativeAffect_Total, IndexLev1_Catastrophizing_Total), ~ !is.na(.)))

data_poweruse <- data_paper2 |>
  filter(!is.na(IndexLev1_Catastrophizing_Total))

model_painave_c <- lmer(IndexLev1_PainAverage ~ IndexLev1_Catastrophizing_Total + (1|ID), data = data_poweruse)

summary(model_painave_c)

powerSim(model_painave_c, fixed("IndexLev1_Catastrophizing_Total", "t"))

model_moreID <- extend(model_painave_c, along = "ID", n = 500)
model_moredayswithinID <- extend(model_painave_c, within = "ID+IndexLev1_Catastrophizing_Total", n = 20)
plot_power <- powerCurve(model_moredayswithinID, within = "ID+IndexLev1_Catastrophizing_Total")
plot(plot_power)


```


```{r}
## Generating graphs
data_paper2 |>
  ggplot(aes(x = IndexLev1_Catastrophizing_Total, y = IndexLev1_PainAverage)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Catastrophizing Score vs. Pain Average", 
       x = "Catastrophizing Score", 
       y = "Pain Average") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) # scatter plot - cata vs painave

data_paper2 |>
  ggplot(aes(x = IndexLev1_PositiveAffect_Total, y = IndexLev1_PainAverage)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Daily Positive Affect vs. Pain Average", 
       x = "Daily Positive Affect", 
       y = "Pain Average") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) # scatter plot - PA vs painave

data_paper2 |>
  ggplot(aes(x = IndexLev1_NegativeAffect_Total, y = IndexLev1_PainAverage)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Daily Negative Affect vs. Pain Average", 
       x = "Daily Negative Affect", 
       y = "Pain Average") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) # scatter plot - NA vs painave
```

```{r}
## Data visualization - multilevel linear plot with Cata vs PainAve - model_painave_cata
library(tidyverse)
library(haven)
library(lme4)
library(lmerTest)
library(ggplot2)
library(dplyr)
library(modelr)
library(broom)
## Daily Cata
model_painave_cata <- lmer(IndexLev1_PainAverage ~  IndexLev1_Catastrophizing_Total + (IndexLev1_Catastrophizing_Total|ID), data = data_paper2)
summary(model_painave_cata)

## Daily NA
model_painave_NA <- lmer(IndexLev1_PainAverage ~  IndexLev1_NegativeAffect_Total + (IndexLev1_NegativeAffect_Total|ID), data = data_paper2)
summary(model_painave_NA)


## Daily PA
model_painave_PA <- lmer(IndexLev1_PainAverage ~  IndexLev1_PositiveAffect_Total + (IndexLev1_PositiveAffect_Total|ID), data = data_paper2)
summary(model_painave_PA)

## Plot - Method 1
data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_Catastrophizing_Total) & !is.na(IndexLev1_PainAverage))
new_data <- expand.grid(
  IndexLev1_Catastrophizing_Total = seq(min(data_paper2_elimna$IndexLev1_Catastrophizing_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_Catastrophizing_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(model_painave_cata, newdata = new_data, re.form = NULL) 

## The mean line
average_predictions <- new_data |>
  group_by(IndexLev1_Catastrophizing_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_Catastrophizing_Total, y = predicted, group = ID), 
            color = "grey", linetype = "dashed") +
  geom_line(data = average_predictions, aes(x = IndexLev1_Catastrophizing_Total, y = mean_predicted), color = "black", size = 1) +
  labs(title = "Association between catastrophizing and daily average pain", 
       x = "Daily catastrophizing", 
       y = "Daily pain intensity") +
  ylim(0,100) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 
############### PA
data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_PositiveAffect_Total) & !is.na(IndexLev1_PainAverage))
new_data <- expand.grid(
  IndexLev1_PositiveAffect_Total = seq(min(data_paper2_elimna$IndexLev1_PositiveAffect_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_PositiveAffect_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(model_painave_PA, newdata = new_data, re.form = NULL) 

## The mean line
average_predictions <- new_data |>
  group_by(IndexLev1_PositiveAffect_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_PositiveAffect_Total, y = predicted, group = ID), 
            color = "grey", linetype = "dashed") +
  geom_line(data = average_predictions, aes(x = IndexLev1_PositiveAffect_Total, y = mean_predicted), color = "black", size = 1) +
  labs(title = "Association between PA and daily average pain", 
       x = "Daily positive affect", 
       y = "Daily pain intensity") +
  ylim(0,100) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

############### NA
model_painave_NA <- lmer(IndexLev1_PainAverage ~  IndexLev1_NegativeAffect_Total + (IndexLev1_NegativeAffect_Total|ID), data = data_paper2)
summary(model_painave_NA)

data_paper2_temp <- data_paper2 |>
  distinct(ID, .keep_all = TRUE) 
median_Baseline_Demog_BMI <- median(data_paper2_temp$Baseline_Demog_BMI, na.rm = TRUE)

data_above_median <- data_paper2 %>% filter(Baseline_Demog_BMI > median_Baseline_Demog_BMI)
length(data_above_median$ID)
data_below_median <- data_paper2 %>% filter(Baseline_Demog_BMI <= median_Baseline_Demog_BMI)
length(data_below_median$ID)
data_paper2 <- data_paper2 |>
  mutate(above_med = ifelse(ID %in% data_above_median$ID,1,0))


data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_NegativeAffect_Total) & !is.na(IndexLev1_PainAverage))
new_data <- expand.grid(
  IndexLev1_NegativeAffect_Total = seq(min(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(model_painave_NA, newdata = new_data, re.form = NULL) 
new_data <- merge(new_data, data_paper2[,c("ID","above_med")], by = "ID", all.x = TRUE)

## The mean line
average_predictions_above <- new_data |>
  filter(above_med == 1) |>
  group_by(IndexLev1_NegativeAffect_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))
average_predictions_below <- new_data |>
  filter(above_med == 0) |>
  group_by(IndexLev1_NegativeAffect_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_NegativeAffect_Total, y = predicted, group = ID, color = factor(above_med)), linetype = "dashed", alpha = 0.5) +
  geom_line(data = average_predictions_above, aes(x = IndexLev1_NegativeAffect_Total, y = mean_predicted), size = 1, color = "blue") +
  geom_line(data = average_predictions_below, aes(x = IndexLev1_NegativeAffect_Total, y = mean_predicted), size = 1, color = "red") +
  labs(title = "Association between NA and daily average pain", 
       x = "Daily negative affect", 
       y = "Daily pain intensity") +
  ylim(0,100) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

```{r}
## Data visualization - multilevel beta regression - Level1_Even_Percent_Transf - beta_cata
data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_Catastrophizing_Total) & !is.na(Level1_Even_Percent_Transf))
new_data <- expand.grid(
  IndexLev1_Catastrophizing_Total = seq(min(data_paper2_elimna$IndexLev1_Catastrophizing_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_Catastrophizing_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(beta_cata, newdata = new_data, re.form = NULL) 

## The mean line
average_predictions <- new_data |>
  group_by(IndexLev1_Catastrophizing_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_Catastrophizing_Total, y = exp(predicted)/(1+exp(predicted)), group = ID), color = "grey") +
  geom_line(data = average_predictions, aes(x = IndexLev1_Catastrophizing_Total, y = exp(mean_predicted)/(1+exp(mean_predicted))), color = "black", size = 1) +
  labs(title = "Association between catastrophizing and perceved % of daily time in pain", 
       x = "Daily catastrophizing", 
       y = "% of daily time in pain") +
  ylim(0,1) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) + # Remove background grids
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

#################### PA
## Data visualization - multilevel beta regression - Level1_Even_Percent_Transf - beta_cata
data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_PositiveAffect_Total) & !is.na(Level1_Even_Percent_Transf))
new_data <- expand.grid(
  IndexLev1_PositiveAffect_Total = seq(min(data_paper2_elimna$IndexLev1_PositiveAffect_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_PositiveAffect_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(beta_PA, newdata = new_data, re.form = NULL) 

## The mean line
average_predictions <- new_data |>
  group_by(IndexLev1_PositiveAffect_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_PositiveAffect_Total, y = exp(predicted)/(1+exp(predicted)), group = ID), color = "grey") +
  geom_line(data = average_predictions, aes(x = IndexLev1_PositiveAffect_Total, y = exp(mean_predicted)/(1+exp(mean_predicted))), color = "black", size = 1) +
  labs(title = "Association between daily PA and perceved % of daily time in pain", 
       x = "Daily positive affect", 
       y = "% of daily time in pain") +
  ylim(0,1) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) + # Remove background grids
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 
#################### NA
## Data visualization - multilevel beta regression - Level1_Even_Percent_Transf - beta_cata
data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_NegativeAffect_Total) & !is.na(Level1_Even_Percent_Transf))
new_data <- expand.grid(
  IndexLev1_NegativeAffect_Total = seq(min(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(beta_NA, newdata = new_data, re.form = NULL) 

## The mean line
average_predictions <- new_data |>
  group_by(IndexLev1_NegativeAffect_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_NegativeAffect_Total, y = exp(predicted)/(1+exp(predicted)), group = ID), color = "grey") +
  geom_line(data = average_predictions, aes(x = IndexLev1_NegativeAffect_Total, y = exp(mean_predicted)/(1+exp(mean_predicted))), color = "black", size = 1) +
  labs(title = "Association between daily NA and perceved % of daily time in pain", 
       x = "Daily negative affect", 
       y = "% of daily time in pain") +
  ylim(0,1) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) + # Remove background grids
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

```

```{r}
## Data visualization - boxplot
data_paper2_boxplot_vars <- data_paper2 |>
  distinct(ID, .keep_all = TRUE) |>
  select(c(ID, IndexLev2_Agg_PainAverage, IndexLev2_Agg_Catastrophizing,
         IndexLev2_Agg_PositiveAffect, IndexLev2_Agg_NegativeAffect)) |>
  pivot_longer(cols = c("IndexLev2_Agg_PainAverage", "IndexLev2_Agg_Catastrophizing",
                        "IndexLev2_Agg_PositiveAffect", "IndexLev2_Agg_NegativeAffect"),
               names_to = "Variable",
               values_to = "Value")

## Boxplot
data_paper2_boxplot_vars |>
  ggplot(aes(x = Variable, y = Value, fill = Variable)) +
  geom_boxplot() +
  geom_jitter(color="black", size=0.4, alpha=0.9) +
  scale_x_discrete(labels = c("Catastrophizing", "Negative Affect", "Pain Average", "Positive Affect")) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) + # Remove background grids
  ggtitle("Boxplot of daily diary scores") +
  xlab("Daily diary subject")

## Violin Plot
data_paper2_boxplot_vars |>
  ggplot(aes(x = Variable, y = Value, fill = Variable)) +
  geom_violin() +
  geom_jitter(color="black", size=0.4, alpha=0.9) +
  scale_x_discrete(labels = c("Catastrophizing", "Negative Affect", "Pain Average", "Positive Affect")) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) + # Remove background grids
  ggtitle("Boxplot of daily diary scores") +
  xlab("Daily diary subject")

## Data visualization - IndexLev1_PainAverage_RawChange ~ NA and PA
data_paper2 |>
  ggplot(aes(x = IndexLev1_NegativeAffect_Total, y = IndexLev1_PainAverage_RawChange)) +
  geom_smooth(method = "lm", level = 0.95) +
  labs(title = "Negative affect vs. Pain change", 
       x = "Daily negative affect", 
       y = "Pain change") +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

data_paper2 |>
  ggplot(aes(y = IndexLev1_PainAverage_RawChange)) +
  geom_smooth(aes(x = IndexLev1_PositiveAffect_Total, y = IndexLev1_PainAverage_RawChange,
                  color = "Positve affect"), 
              method = "lm", level = 0.95) +
  geom_smooth(aes(x = IndexLev1_NegativeAffect_Total, y = IndexLev1_PainAverage_RawChange,
                   color = "Negative affect"), 
              method = "lm", level = 0.95) +
  scale_color_manual(name = "Daily diary variable", values = c("blue", "red")) +
  labs(title = "Daily diary variable vs. Pain change", 
       x = "Daily diary variable", 
       y = "Pain change") +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 
  



```

```{r}
library(broom.mixed)
## Linear graph with confidence interval
## Daily Catastro
model_painave_cata <- lmer(IndexLev1_PainAverage ~  IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_painave_cata)

## Daily NA
model_painave_NA <- lmer(IndexLev1_PainAverage ~  IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_NA)


## Daily PA
model_painave_PA <- lmer(IndexLev1_PainAverage ~  IndexLev1_PositiveAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_PA)

ggplot(data_paper2, aes(x = IndexLev1_Catastrophizing_Total, y = IndexLev1_PainAverage)) +
  stat_smooth(method = "lm", level = 0.95, color = "blue", fill = "lightblue") +
  labs(x = "Catastrophizing", y = "Pain Average") +
  labs(title = "Daily catastrophizing vs. Pain average", 
       x = "Daily catastrophizing", 
       y = "Pain average") +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

ggplot(data_paper2, aes(x = IndexLev1_NegativeAffect_Total, y = IndexLev1_PainAverage)) +
  stat_smooth(method = "lm", level = 0.95, color = "blue", fill = "lightblue") +
  labs(x = "Daily NA", y = "Pain Average") +
  labs(title = "Daily NA vs. Pain average", 
       x = "Daily NA", 
       y = "Pain average") +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

ggplot(data_paper2, aes(x = IndexLev1_PositiveAffect_Total, y = IndexLev1_PainAverage)) +
  stat_smooth(method = "lm", level = 0.95, color = "blue", fill = "lightblue") +
  labs(x = "Daily PA", y = "Pain Average") +
  labs(title = "Daily PA vs. Pain average", 
       x = "Daily PA", 
       y = "Pain average") +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

```

```{r}
library(glmmTMB)
## Beta regression with random slope
## Daily Catastro
beta_cata <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_Catastrophizing_Total + (IndexLev1_Catastrophizing_Total|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))

data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_Catastrophizing_Total) & !is.na(Level1_Even_Percent_Transf))
new_data <- expand.grid(
  IndexLev1_Catastrophizing_Total = seq(min(data_paper2_elimna$IndexLev1_Catastrophizing_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_Catastrophizing_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(beta_cata, newdata = new_data, re.form = NULL) 

## The mean line
average_predictions <- new_data |>
  group_by(IndexLev1_Catastrophizing_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_Catastrophizing_Total, y = exp(predicted)/(1+exp(predicted)), group = ID), color = "grey") +
  geom_line(data = average_predictions, aes(x = IndexLev1_Catastrophizing_Total, y = exp(mean_predicted)/(1+exp(mean_predicted))), color = "black", size = 1) +
  labs(title = "Association between catastrophizing and perceved % of daily time in pain", 
       x = "Daily catastrophizing", 
       y = "% of daily time in pain") +
  ylim(0,1) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) + # Remove background grids
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

## Daily NA
beta_NA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_NegativeAffect_Total + (IndexLev1_NegativeAffect_Total|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))

#################### NA
## Data visualization - multilevel beta regression - Level1_Even_Percent_Transf - beta_cata
data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_NegativeAffect_Total) & !is.na(Level1_Even_Percent_Transf))
new_data <- expand.grid(
  IndexLev1_NegativeAffect_Total = seq(min(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(beta_NA, newdata = new_data, re.form = NULL) 

## The mean line
average_predictions <- new_data |>
  group_by(IndexLev1_NegativeAffect_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_NegativeAffect_Total, y = exp(predicted)/(1+exp(predicted)), group = ID), color = "grey") +
  geom_line(data = average_predictions, aes(x = IndexLev1_NegativeAffect_Total, y = exp(mean_predicted)/(1+exp(mean_predicted))), color = "black", size = 1) +
  labs(title = "Association between daily NA and perceved % of daily time in pain", 
       x = "Daily negative affect", 
       y = "% of daily time in pain") +
  ylim(0,1) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) + # Remove background grids
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 


## Daily PA
beta_PA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_PositiveAffect_Total + (IndexLev1_PositiveAffect_Total|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))


#################### PA
## Data visualization - multilevel beta regression - Level1_Even_Percent_Transf - beta_cata
data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_PositiveAffect_Total) & !is.na(Level1_Even_Percent_Transf))
new_data <- expand.grid(
  IndexLev1_PositiveAffect_Total = seq(min(data_paper2_elimna$IndexLev1_PositiveAffect_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_PositiveAffect_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(beta_PA, newdata = new_data, re.form = NULL) 

## The mean line
average_predictions <- new_data |>
  group_by(IndexLev1_PositiveAffect_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_PositiveAffect_Total, y = exp(predicted)/(1+exp(predicted)), group = ID), color = "grey") +
  geom_line(data = average_predictions, aes(x = IndexLev1_PositiveAffect_Total, y = exp(mean_predicted)/(1+exp(mean_predicted))), color = "black", size = 1) +
  labs(title = "Association between daily PA and perceved % of daily time in pain", 
       x = "Daily positive affect", 
       y = "% of daily time in pain") +
  ylim(0,1) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) + # Remove background grids
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 
```

```{r}
## Beta regression - confidence interval plot
## Beta regression with random slope
## Daily Catastro
beta_cata <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_Catastrophizing_Total + (IndexLev1_Catastrophizing_Total|ID), 
                     family = beta_family(), 
                     data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))

data_paper2_elimna <- data_paper2 |> filter(!is.na(IndexLev1_Catastrophizing_Total) & !is.na(Level1_Even_Percent_Transf))

new_data <- expand.grid(
  IndexLev1_Catastrophizing_Total = seq(min(data_paper2_elimna$IndexLev1_Catastrophizing_Total, na.rm = TRUE), 
                                        max(data_paper2_elimna$IndexLev1_Catastrophizing_Total, na.rm = TRUE), 
                                        length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(beta_cata, newdata = new_data, re.form = NULL)

## Compute mean and confidence intervals
library(dplyr)
library(tidyr)
library(ggplot2)

average_predictions <- new_data |>
  group_by(IndexLev1_Catastrophizing_Total) |>
  summarise(
    mean_predicted = mean(predicted, na.rm = TRUE),
    lower_ci = quantile(predicted, 0.025, na.rm = TRUE),
    upper_ci = quantile(predicted, 0.975, na.rm = TRUE)
  )

ggplot() +
  geom_ribbon(data = average_predictions, 
              aes(x = IndexLev1_Catastrophizing_Total, 
                  ymin = exp(lower_ci)/(1+exp(lower_ci)), 
                  ymax = exp(upper_ci)/(1+exp(upper_ci))), 
              fill = "grey", alpha = 0.5) +
  geom_line(data = average_predictions, 
            aes(x = IndexLev1_Catastrophizing_Total, 
                y = exp(mean_predicted)/(1+exp(mean_predicted))), 
            color = "black", size = 1) +
  labs(title = "Association between catastrophizing and perceived % of daily time in pain", 
       x = "Daily catastrophizing", 
       y = "% of daily time in pain") +
  ylim(0, 1) +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black"),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
##########
## Daily NA
beta_NA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_NegativeAffect_Total + (IndexLev1_NegativeAffect_Total|ID), 
                   family = beta_family(), data = data_paper2, 
                   control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))

## Data visualization - multilevel beta regression - Level1_Even_Percent_Transf - beta_cata
data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_NegativeAffect_Total) & !is.na(Level1_Even_Percent_Transf))

new_data <- expand.grid(
  IndexLev1_NegativeAffect_Total = seq(min(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), 
                                       max(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), 
                                       length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(beta_NA, newdata = new_data, re.form = NULL)

## Compute mean and confidence intervals
average_predictions <- new_data |>
  group_by(IndexLev1_NegativeAffect_Total) |>
  summarise(
    mean_predicted = mean(predicted, na.rm = TRUE),
    lower_ci = quantile(predicted, 0.025, na.rm = TRUE),
    upper_ci = quantile(predicted, 0.975, na.rm = TRUE)
  )

ggplot() +
  geom_ribbon(data = average_predictions, 
              aes(x = IndexLev1_NegativeAffect_Total, 
                  ymin = exp(lower_ci)/(1+exp(lower_ci)), 
                  ymax = exp(upper_ci)/(1+exp(upper_ci))), 
              fill = "grey", alpha = 0.5) +
  geom_line(data = average_predictions, 
            aes(x = IndexLev1_NegativeAffect_Total, 
                y = exp(mean_predicted)/(1+exp(mean_predicted))), 
            color = "black", size = 1) +
  labs(title = "Association between daily NA and perceived % of daily time in pain", 
       x = "Daily negative affect", 
       y = "% of daily time in pain") +
  ylim(0, 1) +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black"),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

## Daily PA
beta_PA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_PositiveAffect_Total + (IndexLev1_PositiveAffect_Total|ID), 
                   family = beta_family(), data = data_paper2, 
                   control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))

## Data visualization - multilevel beta regression - Level1_Even_Percent_Transf - beta_cata
data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_PositiveAffect_Total) & !is.na(Level1_Even_Percent_Transf))

new_data <- expand.grid(
  IndexLev1_PositiveAffect_Total = seq(min(data_paper2_elimna$IndexLev1_PositiveAffect_Total, na.rm = TRUE), 
                                       max(data_paper2_elimna$IndexLev1_PositiveAffect_Total, na.rm = TRUE), 
                                       length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(beta_PA, newdata = new_data, re.form = NULL)

# Compute mean and confidence intervals
average_predictions <- new_data |>
  group_by(IndexLev1_PositiveAffect_Total) |>
  summarise(
    mean_predicted = mean(predicted, na.rm = TRUE),
    lower_ci = quantile(predicted, 0.025, na.rm = TRUE),
    upper_ci = quantile(predicted, 0.975, na.rm = TRUE)
  )

ggplot() +
  geom_ribbon(data = average_predictions, 
              aes(x = IndexLev1_PositiveAffect_Total, 
                  ymin = exp(lower_ci)/(1+exp(lower_ci)), 
                  ymax = exp(upper_ci)/(1+exp(upper_ci))), 
              fill = "grey", alpha = 0.5) +
  geom_line(data = average_predictions, 
            aes(x = IndexLev1_PositiveAffect_Total, 
                y = exp(mean_predicted)/(1+exp(mean_predicted))), 
            color = "black", size = 1) +
  labs(title = "Association between daily PA and perceived % of daily time in pain", 
       x = "Daily positive affect", 
       y = "% of daily time in pain") +
  ylim(0, 1) +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black"),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )


```

```{r}
## Random Effects Testing
## Daily Cata
model_painave_cata <- lmer(IndexLev1_PainAverage ~  IndexLev1_Catastrophizing_Total + (IndexLev1_Catastrophizing_Total|ID), data = data_paper2)
model_painave_cata_norand <- lm(IndexLev1_PainAverage ~  IndexLev1_Catastrophizing_Total, data = data_paper2)
anova(model_painave_cata, model_painave_cata_norand)
#summary(model_painave_cata)

## Daily NA
model_painave_NA <- lmer(IndexLev1_PainAverage ~  IndexLev1_NegativeAffect_Total + (IndexLev1_NegativeAffect_Total|ID), data = data_paper2)
model_painave_NA_norand <- lm(IndexLev1_PainAverage ~  IndexLev1_NegativeAffect_Total, data = data_paper2)
anova(model_painave_NA, model_painave_NA_norand)
#summary(model_painave_NA)


## Daily PA
model_painave_PA <- lmer(IndexLev1_PainAverage ~  IndexLev1_PositiveAffect_Total + (IndexLev1_PositiveAffect_Total|ID), data = data_paper2)
model_painave_PA_norand <- lm(IndexLev1_PainAverage ~  IndexLev1_PositiveAffect_Total, data = data_paper2)
anova(model_painave_PA, model_painave_PA_norand)
#summary(model_painave_PA)
```

```{r}
## IndexLev1_PainAverage_RawChange
## Daily Cata
model_painave_cata <- lmer(IndexLev1_PainAverage_RawChange ~  IndexLev1_Catastrophizing_Total + (IndexLev1_Catastrophizing_Total|ID), data = data_paper2)
model_painave_cata_norand <- lm(IndexLev1_PainAverage_RawChange ~  IndexLev1_Catastrophizing_Total, data = data_paper2)
anova(model_painave_cata, model_painave_cata_norand)
#summary(model_painave_cata)

## Daily NA
model_painave_NA <- lmer(IndexLev1_PainAverage_RawChange ~  IndexLev1_NegativeAffect_Total + (IndexLev1_NegativeAffect_Total|ID), data = data_paper2)
model_painave_NA_norand <- lm(IndexLev1_PainAverage_RawChange ~  IndexLev1_NegativeAffect_Total, data = data_paper2)
anova(model_painave_NA, model_painave_NA_norand)
#summary(model_painave_NA)


## Daily PA
model_painave_PA <- lmer(IndexLev1_PainAverage_RawChange ~  IndexLev1_PositiveAffect_Total + (IndexLev1_PositiveAffect_Total|ID), data = data_paper2)
model_painave_PA_norand <- lm(IndexLev1_PainAverage_RawChange ~  IndexLev1_PositiveAffect_Total, data = data_paper2)
anova(model_painave_PA, model_painave_PA_norand)
```

```{r}
library(betareg)
library(lmtest)
## Daily Catastro
beta_cata <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_Catastrophizing_Total + (IndexLev1_Catastrophizing_Total|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
beta_cata_norand <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_Catastrophizing_Total,
                            family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
AIC(beta_cata, beta_cata_norand)
lrtest(beta_cata, beta_cata_norand)


## Daily NA
beta_NA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_NegativeAffect_Total + (IndexLev1_NegativeAffect_Total|ID), 
                   family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
beta_NA_norand <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_NegativeAffect_Total,
                          family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
lrtest(beta_NA, beta_NA_norand)

## Daily PA
beta_PA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_PositiveAffect_Total + (IndexLev1_PositiveAffect_Total|ID), 
                   family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
beta_PA_norand <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_PositiveAffect_Total , 
                   family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
lrtest(beta_PA, beta_PA_norand)

```

```{r}
## Testing the baseline/charac variables for beta regression
beta_Age <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_Age + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_Age)
## Age * PPTh
beta_AgePPTh <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_Age*IndexLev2_QST_BaselinePPTh + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_AgePPTh)
## Age * TSP
beta_AgeTSP <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_Age*IndexLev2_QST_TSPAve + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_AgeTSP)
## Age * CPM
beta_AgeCPM <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_Age*IndexLev2_QST_CpmTrialAve + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_AgeCPM)
## Age * PA
beta_AgePA <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_Age*IndexLev1_PositiveAffect_Total + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_AgePA)
## Age * NA
beta_AgeNA <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_Age*IndexLev1_NegativeAffect_Total + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_AgeNA)
## Age * Cata
beta_AgeCata <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_Age*IndexLev1_Catastrophizing_Total + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_AgeCata)

beta_Sex <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_Sex + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_Sex)

beta_BMI <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_BMI + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_BMI)
## BMI * PPTh
beta_BMIPPTh <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_BMI*IndexLev2_QST_BaselinePPTh + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_BMIPPTh)
## BMI * TSP
beta_BMITSP <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_BMI*IndexLev2_QST_TSPAve + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_BMITSP)
## BMI * CPM
beta_BMICPM <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_BMI*IndexLev2_QST_CpmTrialAve + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_BMICPM)
## BMI * PA
beta_BMIPA <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_BMI*IndexLev1_PositiveAffect_Total + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_BMIPA)
## BMI * NA
beta_BMINA <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_BMI*IndexLev1_NegativeAffect_Total + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_BMINA)
## BMI * Cata
beta_BMICata <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_BMI*IndexLev1_Catastrophizing_Total + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_BMICata)

beta_Eth <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Demog_Ethnicity_Rec + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_Eth)

beta_Smoke <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Lifestyle_SmokePerday + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_Smoke)

beta_Acetam <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Meds_Acetaminophen + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_Acetam)

beta_NSAID <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Meds_NSAID + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_NSAID)

beta_AntiDep <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Meds_Antidepressants + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_AntiDep)

beta_Anxio <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Meds_Anxiolytics + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_Anxio)

beta_Muscle <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Meds_MuscleRelaxants + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_Muscle)

beta_Opioids <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Meds_Opioids + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_Opioids)

beta_AntiConv <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Meds_Anticonvulsants + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_AntiConv)

beta_Cox2 <- glmmTMB(Level1_Even_Percent_Transf ~ Baseline_Meds_Cox2 + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_Cox2)

```

```{r}
## Pain Percent interaction check
beta_cata <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_Catastrophizing_Total*IndexLev2_QST_CpmTrialAve + (1|ID), family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_cata)

beta_PA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_PositiveAffect_Total*IndexLev2_QST_CpmTrialAve + (1|ID), 
                   family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_PA)

beta_NA <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev1_NegativeAffect_Total*IndexLev2_QST_CpmTrialAve + (1|ID), 
                   family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_NA)

```


```{r}
## Pain Ave interaction checking
model_painave_age_inter <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_BaselinePPTh*IndexLev1_PositiveAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_age_inter) 

model_painave_age_inter <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_BaselinePPTh*IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_age_inter) 

model_painave_age_inter <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_QST_BaselinePPTh*IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_painave_age_inter) 


model_painave_bmi_inter <- lmer(IndexLev1_PainAverage ~ Baseline_Demog_BMI*IndexLev1_PositiveAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_bmi_inter) 

model_painave_bmi_inter <- lmer(IndexLev1_PainAverage ~ Baseline_Demog_BMI*IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_bmi_inter) #Significant

data_paper2_temp <- data_paper2 |>
  filter(above_med == 1)
model_painave_bmi_inter <- lmer(IndexLev1_PainAverage ~ IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2_temp)
summary(model_painave_bmi_inter) #Significant
data_paper2_temp <- data_paper2 |>
  filter(above_med == 0)
model_painave_bmi_inter <- lmer(IndexLev1_PainAverage ~ IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2_temp)
summary(model_painave_bmi_inter) #Significant



model_painave_bmi_inter <- lmer(IndexLev1_PainAverage ~ Baseline_Demog_BMI*IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_painave_bmi_inter) 

model_painave_NSAID_inter <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_NSAID*IndexLev1_PositiveAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_NSAID_inter) 

model_painave_NSAID_inter <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_NSAID*IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_NSAID_inter) 

model_painave_NSAID_inter <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_NSAID*IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_painave_NSAID_inter) 

model_painave_AntiConv_inter <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_Anticonvulsants*IndexLev1_PositiveAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_AntiConv_inter) 

model_painave_AntiConv_inter <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_Anticonvulsants*IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_AntiConv_inter) 

model_painave_AntiConv_inter <- lmer(IndexLev1_PainAverage ~ Baseline_Meds_Anticonvulsants*IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_painave_AntiConv_inter) 

```





Comparing the more complex model to the null model (Less complex model). The null hypothesis in this case is "Using the random effect model does not improve the model fit compared to the model without the random effect".  


```{r}
## Density plot for three QST measures
data_paper_temp <- data_paper2 |>
  distinct(ID, .keep_all = TRUE)
ggplot(data_paper_temp, aes(x = IndexLev2_QST_BaselinePPTh)) + 
  geom_density(alpha = 0.2, fill = "#FF6666") +
  labs(title = "Density of PPTh", 
       x = "PPTh", 
       y = "Density") +
  scale_x_continuous(breaks = seq(0, 1200, by = 150)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

ggplot(data_paper_temp, aes(x = IndexLev2_QST_TSPAve)) + 
  geom_density(alpha = 0.2, fill = "green") +
  labs(title = "Density of TSP", 
       x = "TSP", 
       y = "Density") +
  scale_x_continuous(breaks = seq(0, 95, by = 5)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 

ggplot(data_paper_temp, aes(x = IndexLev2_QST_CpmTrialAve)) + 
  geom_density(alpha = 0.2, fill = "orange") +
  labs(title = "Density of CPM", 
       x = "CPM", 
       y = "Density") +
  scale_x_continuous(breaks = seq(0, 255, by = 15)) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 
  
```

```{r}
## Moon Paper - R code for computing individual mean, MSSD, and PAC
library(foreign)
library(psych)

varim <- function(filename,idv,tv,xv,ac,tint){
  # Read data file
  if (grepl(".dat",filename,fixed=T)){
    mydata0 <- read.table(filename,sep="\t",fileEncoding="UTF-8-BOM")
    filetype <- 1
  } else if (grepl(".csv",filename,fixed=T)){
    mydata0 <- read.table(filename,sep=",", fileEncoding="UTF-8-BOM")
    filetype <- 2
  } else if (grepl(".sav",filename,fixed=T)){
    mydata0 <- read.spss(filename,to.data.frame=T,use.missings=T,use.value.labels=F)
    filetype <- 3
  } else if (grepl(".xpt",filename,fixed=T)){
    mydata0 <- read.xport(filename)
    filetype <- 4
  } else {
    stop("unrecognized file type")
  }
  # Select id, time, x variables only.
  mydata = data.frame(id=mydata0[,idv],time=mydata0[,tv],x=mydata0[,xv])
  # Calculate variability measures
  mydata.v <- round(vm(data0=mydata,idv="id",xv="x",tv="time",tint=tint,ac=ac),4)
  # Save the variability measures data
  now <- Sys.time()
  if (filetype==1){
    filename.r <- paste("varim_",format(now, "%m%d%Y_%H%M%S"),".dat")
    write.table(x=mydata.v,file=filename.r,row.names=F,col.names=T,sep="\t")
  } else if (filetype==2){
    filename.r <- paste("varim_",format(now, "%m%d%Y_%H%M%S"),".csv")
    write.table(x=mydata.v,file=filename.r,row.names=F,col.names=T,sep=",")
  } else if (filetype==3){
    filename.data <- paste("varim_",format(now, "%m%d%Y_%H%M%S"),".txt")
    filename.code <- paste("varim_",format(now, "%m%d%Y_%H%M%S"),".sps")
    write.foreign(df=mydata.v,datafile=filename.data,codefile=filename.code,package="SPSS")
  } else if (filetype==4){
    filename.data <- paste("varim_",format(now, "%m%d%Y_%H%M%S"),".txt")
    filename.code <- paste("varim_",format(now, "%m%d%Y_%H%M%S"),".sas")
    
  write.foreign(df=mydata.v,datafile=filename.data,codefile=filename.code,package="SAS")
  }
}
# vm function: Calculate variability measures and return a data frame
vm <- function(data0,idv,xv,tv,tint,ac){
 
  data <- data0
  id <- data[,idv]
  x <- data[,xv]
  t <- data[,tv]
 
  unique.id <- unique(id)
  mydata <- c()
 
  for(j in 1:length(unique.id)){
    t.j <- t[id==unique.id[j]]
    x.j <- x[id==unique.id[j]]
    t.new <- seq(min(t.j),max(t.j),by=tint)
    x.new <- rep(NA,times=length(t.new))
    id.new <- rep(unique.id[j],times=length(t.new))
 
    index <- which((t.new %in% t.j))
    x.new[index] <- x.j
 
    data.new <- data.frame(id=id.new,t=t.new,x=x.new)
    mydata <- rbind(mydata,data.new)
  }
 
  # Calculate variability measures for each person
  MEAN <- tapply(X=mydata$x,INDEX=mydata$id,function(x) mean(x,na.rm=T))
  MSSD <- tapply(X=mydata$x,INDEX=mydata$id,function(x) mean(diff(x,lag=1)^2,na.rm=T))
  PAC <- tapply(X=mydata$x,INDEX=mydata$id,function(x) 
  mean(abs(diff(x,lag=1))>ac,na.rm=T))
 
  # Create data frame
  id <- as.numeric(rownames(MEAN))
  vm <- data.frame(id,MEAN,MSSD,PAC)
 
  colnames(vm) <- c("ID","MEAN","MSSD","PAC")
 
  return(vm)
}
###############
##### End #####
###############
varim(filename = "data_paper2.sav", idv = "ID", tv = "Wave_Day", xv = "IndexLev1_PainAverage",
      ac = 20, tint = 1)
data_MSSD <- readr::read_delim("varim_ 07292024_011555 .txt", delim = ",", col_names = c("ID", "MEAN", "MSSD", "PAC", "Ignore"))
data_MSSD <- data_MSSD |> select(-"Ignore")
data_paper2_temp <- data_paper2 |>
  distinct(ID, .keep_all = TRUE)
data_paper2_withMSSD <- merge(data_paper2_temp, data_MSSD, by = "ID")
model_MSSD_CPM <- lm(MSSD ~ IndexLev2_QST_CpmTrialAve, data = data_paper2_withMSSD)
model_MSSD_CPM_controlpain <- lm(MSSD ~ IndexLev2_QST_CpmTrialAve + IndexLev2_Agg_PainAverage, data = data_paper2_withMSSD)

model_MSSD_PPTh <- lm(MSSD ~ IndexLev2_QST_BaselinePPTh, data = data_paper2_withMSSD)
model_MSSD_PPTh_controlpain <- lm(MSSD ~ IndexLev2_QST_BaselinePPTh + IndexLev2_Agg_PainAverage, data = data_paper2_withMSSD)

model_MSSD_TSP <- lm(MSSD ~ IndexLev2_QST_TSPAve, data = data_paper2_withMSSD)
model_MSSD_TSP_controlpain <- lm(MSSD ~ IndexLev2_QST_TSPAve + IndexLev2_Agg_PainAverage, data = data_paper2_withMSSD)


model_MSSD_PA <- lm(MSSD ~ IndexLev2_Agg_PositiveAffect, data = data_paper2_withMSSD)
model_MSSD_NA <- lm(MSSD ~ IndexLev2_Agg_NegativeAffect, data = data_paper2_withMSSD)
model_MSSD_Cata <- lm(MSSD ~ IndexLev2_Agg_Catastrophizing, data = data_paper2_withMSSD)
model_MSSD <- lm(MSSD ~ IndexLev2_QST_CpmTrialAve + IndexLev2_QST_BaselinePPTh + IndexLev2_QST_TSPAve,
                 data = data_paper2_withMSSD)
summary(model_MSSD_CPM)
summary(model_MSSD_PPTh)
summary(model_MSSD_TSP)


summary(model_MSSD_CPM_controlpain)
summary(model_MSSD_PPTh_controlpain)
summary(model_MSSD_TSP_controlpain)

summary(model_MSSD_PA)
summary(model_MSSD_NA)
summary(model_MSSD_Cata)

summary(model_MSSD)
```

```{r}
## Re-classify the BMI into categorical using CDC index
data_paper2 <- data_paper2 |>
  mutate(IndexLev2_Categorized_BMI = case_when(
    Baseline_Demog_BMI < 18.5 ~ "Underweight",
    Baseline_Demog_BMI >= 18.5 & Baseline_Demog_BMI < 25 ~ "Healthy Weight",
    Baseline_Demog_BMI >= 25 & Baseline_Demog_BMI < 30 ~ "Overweight",
    Baseline_Demog_BMI >= 30 ~ "Obesity"
  )) # Nobody underweight

## Re-run the analyses that involved with BMI

## Pain Raw Change
model_bmi <- lmer(IndexLev1_PainAverage_RawChange ~ IndexLev2_Categorized_BMI + (1|ID), data = data_paper2)
summary(model_bmi)
confint(model_bmi, method = "Wald")
icc(model_bmi)

## Pain Average
model_painave_BMI <- lmer(IndexLev1_PainAverage ~ IndexLev2_Categorized_BMI + (1|ID), data = data_paper2)
summary(model_painave_BMI)#Significant
confint(model_painave_BMI, method = "Wald")
icc(model_painave_BMI)

## Adjusted Pain Average
model_painave_lev2adj <- lmer(IndexLev1_PainAverage ~ IndexLev2_QST_BaselinePPTh + IndexLev2_QST_TSPAve + IndexLev2_QST_CpmTrialAve + Baseline_Demog_Age + IndexLev2_Categorized_BMI + Baseline_Meds_NSAID + Baseline_Meds_Anticonvulsants + (1|ID), data = data_paper2)
summary(model_painave_lev2adj)
confint(model_painave_lev2adj, method = "Wald")
icc(model_painave_lev2adj)

## Percent Pain
beta_BMI <- glmmTMB(Level1_Even_Percent_Transf ~ IndexLev2_Categorized_BMI + (1|ID), 
                     family = beta_family(), data = data_paper2, 
                     control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")))
summary(beta_BMI)
confint(beta_BMI, method = "Wald") # log OR
exp(confint(beta_BMI, method = "Wald")) # OR
icc(beta_BMI)

## Pain Average - NA PA Cata interaction with BMI
model_painave_bmi_inter <- lmer(IndexLev1_PainAverage ~ IndexLev2_Categorized_BMI*IndexLev1_PositiveAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_bmi_inter) 
confint(model_painave_bmi_inter, method = "Wald")
icc(model_painave_bmi_inter)

model_painave_bmi_inter <- lmer(IndexLev1_PainAverage ~ IndexLev2_Categorized_BMI*IndexLev1_NegativeAffect_Total + (1|ID), data = data_paper2)
summary(model_painave_bmi_inter) 
confint(model_painave_bmi_inter, method = "Wald")
icc(model_painave_bmi_inter)

model_painave_bmi_inter <- lmer(IndexLev1_PainAverage ~ IndexLev2_Categorized_BMI*IndexLev1_Catastrophizing_Total + (1|ID), data = data_paper2)
summary(model_painave_bmi_inter) 
confint(model_painave_bmi_inter, method = "Wald")
icc(model_painave_bmi_inter)

data_paper2_temp <- data_paper2 |>
  distinct(ID, .keep_all = TRUE)
table(data_paper2_temp$IndexLev2_Categorized_BMI)
data_paper2_temp <- data_paper2_temp |>
  filter(!is.na(IndexLev2_Categorized_BMI))

data_paper2_temp |>
  ggplot(aes(x = factor(IndexLev2_Categorized_BMI, levels = c("Healthy Weight", "Overweight", "Obesity")), fill = factor(IndexLev2_Categorized_BMI, levels = c("Healthy Weight", "Overweight", "Obesity")))) +
  geom_bar() +
  labs(fill = "BMI", x = "BMI", y = "Count") +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```


```{r}
############### NA interaction with BMI
model_painave_NA <- lmer(IndexLev1_PainAverage ~  IndexLev1_NegativeAffect_Total + (IndexLev1_NegativeAffect_Total|ID), data = data_paper2)
summary(model_painave_NA)

data_paper2_temp <- data_paper2 |>
  distinct(ID, .keep_all = TRUE) 
median_Baseline_Demog_BMI <- median(data_paper2_temp$Baseline_Demog_BMI, na.rm = TRUE)

data_above_median <- data_paper2 %>% filter(Baseline_Demog_BMI > median_Baseline_Demog_BMI)
length(data_above_median$ID)
data_below_median <- data_paper2 %>% filter(Baseline_Demog_BMI <= median_Baseline_Demog_BMI)
length(data_below_median$ID)
data_paper2 <- data_paper2 |>
  mutate(above_med = ifelse(ID %in% data_above_median$ID,1,0))


data_paper2_elimna <- data_paper2 |>
  filter(!is.na(IndexLev1_NegativeAffect_Total) & !is.na(IndexLev1_PainAverage))
new_data <- expand.grid(
  IndexLev1_NegativeAffect_Total = seq(min(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), 
                              max(data_paper2_elimna$IndexLev1_NegativeAffect_Total, na.rm = TRUE), length.out = 100),
  ID = unique(data_paper2_elimna$ID)
)

new_data$predicted <- predict(model_painave_NA, newdata = new_data, re.form = NULL) 
new_data <- merge(new_data, data_paper2[,c("ID","above_med")], by = "ID", all.x = TRUE)

## The mean line
average_predictions_above <- new_data |>
  filter(above_med == 1) |>
  group_by(IndexLev1_NegativeAffect_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))
average_predictions_below <- new_data |>
  filter(above_med == 0) |>
  group_by(IndexLev1_NegativeAffect_Total) |>
  summarise(mean_predicted = mean(predicted, na.rm = TRUE))

ggplot() +
  geom_line(data = new_data, aes(x = IndexLev1_NegativeAffect_Total, y = predicted, group = ID, color = factor(above_med)), linetype = "dashed", alpha = 0.5) +
  geom_line(data = average_predictions_above, aes(x = IndexLev1_NegativeAffect_Total, y = mean_predicted), size = 1, color = "blue") +
  geom_line(data = average_predictions_below, aes(x = IndexLev1_NegativeAffect_Total, y = mean_predicted), size = 1, color = "red") +
  labs(title = "Association between NA and daily average pain", 
       x = "Daily negative affect", 
       y = "Daily pain intensity") +
  ylim(0,100) +
  theme_minimal() +
  theme(element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```























